#!/bin/bash
# =====================================================
# ShowOn Script Manager V.1.0.8 (Extended Edition)
# Author : TspKchn + ChatGPT
# =====================================================

# ----------------- เวอร์ชัน -----------------
VERSION="V.1.0.8"

# ----------------- พาธรีโป ------------------
REPO_RAW="https://raw.githubusercontent.com/TspKchn/showon/main"

# ----------------- ซอร์สไฟล์ ----------------
SRC_ONLINE="$REPO_RAW/scripts/online-check.sh"
SRC_VNSTAT="$REPO_RAW/scripts/vnstat-traffic.sh"
SRC_V2RAY="$REPO_RAW/scripts/v2ray-traffic.sh"
SRC_SYSINFO="$REPO_RAW/scripts/sysinfo.sh"
SRC_INDEX="$REPO_RAW/web/index.html"

# ----------------- ตำแหน่งติดตั้ง ----------
WWW_DIR="/var/www/html/server"
BIN_DIR="/usr/local/bin"
CONF_FILE="/etc/showon.conf"
DEBUG_LOG="/var/log/showon-debug.log"

SCRIPT_ONLINE="$BIN_DIR/online-check.sh"
SCRIPT_VNSTAT="$BIN_DIR/vnstat-traffic.sh"
SCRIPT_V2RAY="$BIN_DIR/v2ray-traffic.sh"
SCRIPT_SYSINFO="$BIN_DIR/sysinfo.sh"

SERVICE_ONLINE="/etc/systemd/system/online-check.service"
SERVICE_VNSTAT="/etc/systemd/system/vnstat-traffic.service"
SERVICE_V2RAY="/etc/systemd/system/v2ray-traffic.service"
SERVICE_SYSINFO="/etc/systemd/system/sysinfo.service"

SITE_AV="/etc/nginx/sites-available/showon"
SITE_EN="/etc/nginx/sites-enabled/showon"

# ----------------- สี ------------------------
GREEN="\e[32m"; RED="\e[31m"; YELLOW="\e[33m"; CYAN="\e[36m"; B="\e[1m"; NC="\e[0m"

# =====================================================
# ฟังก์ชันพื้นฐาน
# =====================================================

require_root() {
  if [[ $EUID -ne 0 ]]; then
    echo -e "${RED}[ERROR]${NC} Please run as root."
    exit 1
  fi
}

press() { read -rp "Press Enter to continue..." _; }

get_nic() {
  ip -o -4 route get 8.8.8.8 2>/dev/null \
    | awk '{for(i=1;i<=NF;i++) if($i=="dev") print $(i+1)}' \
    | head -n1
}

rotate_log() {
  local max=1000000
  if [[ -f "$DEBUG_LOG" && $(stat -c%s "$DEBUG_LOG") -gt $max ]]; then
    mv "$DEBUG_LOG" "$DEBUG_LOG.1"
    : > "$DEBUG_LOG"
  fi
}

download_or_die() {
  local url="$1" dst="$2"
  if ! curl -fsSL "$url" -o "$dst"; then
    echo -e "${RED}[ERROR]${NC} Download failed: $url"
    exit 1
  fi
}

write_nginx() {
  mkdir -p "$WWW_DIR"
  mkdir -p /etc/nginx/sites-available /etc/nginx/sites-enabled

  rm -f /etc/nginx/sites-enabled/default
  rm -f /etc/nginx/sites-available/default

  cat >"$SITE_AV" <<EOF
server {
    listen $SHOWON_PORT default_server;
    server_name _;

    location /server/ {
        alias $WWW_DIR/;
        index index.html;
        autoindex off;
        add_header Cache-Control "no-store";

        location ~ /server/online_app(\.json)?\$ {
            default_type application/json;
            add_header Content-Type application/json;
        }
    }
}
EOF

  ln -sf "$SITE_AV" "$SITE_EN"

  if nginx -t; then
    systemctl restart nginx 2>/dev/null || true
  else
    echo -e "${YELLOW}[WARN]${NC} nginx config test failed, forcing restart..."
    systemctl restart nginx 2>/dev/null || true
  fi

  echo -e "${GREEN}[OK]${NC} Nginx is now listening on port :$SHOWON_PORT (/server/)"
}

conntrack_status() {
  if command -v conntrack >/dev/null 2>&1; then echo "ON"; else echo "OFF"; fi
}

check_update() {
  local remote install_raw
  install_raw="$(curl -fsSL "$REPO_RAW/Install" || true)"

  if [[ -z "$install_raw" ]]; then
    echo -e "${YELLOW}[WARN]${NC} Cannot check version from GitHub"
    return
  fi

  remote="$(printf '%s' "$install_raw" | grep -m1 '^VERSION=' | cut -d'"' -f2)"
  if [[ -z "$remote" ]]; then
    echo -e "${YELLOW}[WARN]${NC} Found Install file but VERSION not found"
    return
  fi

  if [[ "$VERSION" == "$remote" ]]; then
    echo -e "${GREEN}[OK]${NC} You are using the latest version."
  else
    echo -e "${CYAN}[UPDATE]${NC} New version: ${remote} (current: ${VERSION})"
    echo -en "Press Enter to update now or type ${B}n${NC} to skip: "
    read ans
    if [[ -z "$ans" || "$ans" == "y" || "$ans" == "Y" ]]; then
      update_script
      clear
      print_status
      check_update
      show_menu
    fi
  fi
}

print_status() {
  local stat_nginx="OFF" stat_online="OFF" stat_vnstat="OFF" stat_v2="OFF" stat_sys="OFF"

  systemctl is-active --quiet nginx && stat_nginx="ON"
  [[ -f "$SERVICE_ONLINE" ]] && systemctl is-active --quiet online-check && stat_online="ON"
  [[ -f "$SERVICE_VNSTAT" ]] && systemctl is-active --quiet vnstat-traffic && stat_vnstat="ON"
  [[ -f "$SERVICE_V2RAY" ]] && systemctl is-active --quiet v2ray-traffic && stat_v2="ON"
  [[ -f "$SERVICE_SYSINFO" ]] && systemctl is-active --quiet sysinfo && stat_sys="ON"

  local c_ng=$( [[ "$stat_nginx" == "ON" ]] && echo "$GREEN" || echo "$RED" )
  local c_on=$( [[ "$stat_online" == "ON" ]] && echo "$GREEN" || echo "$RED" )
  local c_vn=$( [[ "$stat_vnstat" == "ON" ]] && echo "$GREEN" || echo "$RED" )
  local c_v2=$( [[ "$stat_v2" == "ON" ]] && echo "$GREEN" || echo "$RED" )
  local c_sy=$( [[ "$stat_sys" == "ON" ]] && echo "$GREEN" || echo "$RED" )
  local c_ct=$( [[ "$(conntrack_status)" == "ON" ]] && echo "$GREEN" || echo "$RED" )

  local installed="${RED}✘ Not Installed  ${NC}"
  if [[ -f "$SCRIPT_ONLINE" || -f "$SCRIPT_VNSTAT" || -f "$SCRIPT_V2RAY" || -f "$SCRIPT_SYSINFO" ]]; then
    installed="${GREEN}✔ Installed  ${NC}"
  fi

  echo "==============================="
  echo "   ShowOn Script Manager ${VERSION}"
  echo "==============================="
  echo -e "$(printf 'NginX   : [%b%s%b]  Online Check : [%b%s%b]\n' "$c_ng" "$stat_nginx" "$NC" "$c_on" "$stat_online" "$NC")"
  echo -e "$(printf 'vnStat  : [%b%s%b]  V2Ray Traffic: [%b%s%b]\n' "$c_vn" "$stat_vnstat" "$NC" "$c_v2" "$stat_v2" "$NC")"
  echo -e "$(printf 'SysInfo : [%b%s%b]  Conntrack    : [%b%s%b]\n' "$c_sy" "$stat_sys" "$NC" "$c_ct" "$(conntrack_status)" "$NC")"
  echo "-------------------------------"
  echo -e "Status: $installed"
  echo "==============================="
}
# =====================================================
# ฟังก์ชันตรวจสอบและเลือก IP Public
# =====================================================
get_public_ip() {
  echo -e "${CYAN}[INFO]${NC} Checking for Public IP address..."
  local ip_sources=("ifconfig.me" "icanhazip.com" "api.ipify.org")
  for site in "${ip_sources[@]}"; do
    IP_PUBLIC=$(curl -s --max-time 5 "https://${site}" | grep -Eo '([0-9]{1,3}\.){3}[0-9]{1,3}')
    if [[ -n "$IP_PUBLIC" && "$IP_PUBLIC" != 192.* && "$IP_PUBLIC" != 10.* && "$IP_PUBLIC" != 172.1[6-9].* && "$IP_PUBLIC" != 172.2[0-9].* && "$IP_PUBLIC" != 172.3[0-1].* ]]; then
      echo -e "${GREEN}[OK]${NC} Public IP detected: ${IP_PUBLIC}"
      return
    fi
  done

  echo -e "${YELLOW}[WARN]${NC} Unable to automatically detect public IP."
  read -rp "Please enter your server Public IP manually: " IP_PUBLIC
  if [[ -z "$IP_PUBLIC" ]]; then
    echo -e "${RED}[ERROR]${NC} Public IP cannot be empty."
    exit 1
  fi
}

# =====================================================
# ฟังก์ชันติดตั้งหลัก
# =====================================================
install_showon() {
  clear
  echo "==============================="
  echo "    Installing ShowOn Script"
  echo "==============================="

  # ตรวจสิทธิ์
  require_root

  # ตรวจหา IP
  get_public_ip

  # กำหนด PORT
  echo -e "${CYAN}[INPUT]${NC} Enter Port for ShowOn (default 82): "
  read -rp "Port: " SHOWON_PORT
  SHOWON_PORT=${SHOWON_PORT:-82}

  echo -e "${CYAN}[INFO]${NC} Installing dependencies..."
  apt update -y >/dev/null 2>&1
  apt install -y nginx curl jq unzip vnstat conntrack >/dev/null 2>&1

  echo -e "${GREEN}[OK]${NC} Dependencies installed."

  # สร้าง Script ไฟล์
  echo -e "${CYAN}[INFO]${NC} Downloading ShowOn modules..."
  download_or_die "$SRC_ONLINE" "$SCRIPT_ONLINE"
  download_or_die "$SRC_VNSTAT" "$SCRIPT_VNSTAT"
  download_or_die "$SRC_V2RAY" "$SCRIPT_V2RAY"
  download_or_die "$SRC_SYSINFO" "$SCRIPT_SYSINFO"
  chmod +x "$SCRIPT_ONLINE" "$SCRIPT_VNSTAT" "$SCRIPT_V2RAY" "$SCRIPT_SYSINFO"

  # สร้างหน้าเว็บ
  download_or_die "$SRC_INDEX" "$WWW_DIR/index.html"

  # เขียน Nginx config
  write_nginx

  # สร้าง Service ต่าง ๆ
  echo -e "${CYAN}[INFO]${NC} Setting up systemd services..."
  cat >"$SERVICE_ONLINE" <<EOF
[Unit]
Description=Online Check Service
After=network.target

[Service]
ExecStart=$SCRIPT_ONLINE
Restart=always

[Install]
WantedBy=multi-user.target
EOF

  cat >"$SERVICE_VNSTAT" <<EOF
[Unit]
Description=vnStat Traffic Monitor
After=network.target

[Service]
ExecStart=$SCRIPT_VNSTAT
Restart=always

[Install]
WantedBy=multi-user.target
EOF

  cat >"$SERVICE_V2RAY" <<EOF
[Unit]
Description=V2Ray Traffic Monitor
After=network.target

[Service]
ExecStart=$SCRIPT_V2RAY
Restart=always

[Install]
WantedBy=multi-user.target
EOF

  cat >"$SERVICE_SYSINFO" <<EOF
[Unit]
Description=System Information Monitor
After=network.target

[Service]
ExecStart=$SCRIPT_SYSINFO
Restart=always

[Install]
WantedBy=multi-user.target
EOF

  # เริ่มต้นการทำงานของ service ทั้งหมด
  systemctl daemon-reload
  systemctl enable online-check vnstat-traffic v2ray-traffic sysinfo >/dev/null 2>&1
  systemctl restart online-check vnstat-traffic v2ray-traffic sysinfo >/dev/null 2>&1

  # สร้างคำสั่ง showon
  echo -e "${CYAN}[INFO]${NC} Creating ShowOn command shortcut..."
  cat > /usr/local/bin/showon <<EOF
#!/bin/bash
bash /usr/local/bin/Install
EOF
  chmod +x /usr/local/bin/showon

  echo -e "${GREEN}[OK]${NC} Installation completed!"
  echo "-----------------------------------------"
  echo -e "Access URL: ${CYAN}http://${IP_PUBLIC}:${SHOWON_PORT}/server/${NC}"
  echo -e "To run menu again, type: ${GREEN}showon${NC}"
  echo "-----------------------------------------"
  press
}

# =====================================================
# เมนูจัดการ
# =====================================================
change_port() {
  clear
  echo "==============================="
  echo "       Change ShowOn Port"
  echo "==============================="
  read -rp "Enter new port (current: $SHOWON_PORT): " NEW_PORT
  [[ -z "$NEW_PORT" ]] && echo -e "${RED}[ERROR]${NC} Port cannot be empty." && return
  SHOWON_PORT="$NEW_PORT"
  write_nginx
  echo -e "${GREEN}[OK]${NC} Port changed to $SHOWON_PORT"
  press
}

setup_swap() {
  clear
  echo "==============================="
  echo "       Setup Swap Memory"
  echo "==============================="
  read -rp "Enter swap size (e.g. 1G, 2G): " SWAP_SIZE
  fallocate -l "$SWAP_SIZE" /swapfile
  chmod 600 /swapfile
  mkswap /swapfile
  swapon /swapfile
  echo '/swapfile none swap sw 0 0' >> /etc/fstab
  echo -e "${GREEN}[OK]${NC} Swap $SWAP_SIZE created successfully."
  press
}
# =====================================================
# ฟังก์ชันถอนการติดตั้ง
# =====================================================
uninstall_showon() {
  clear
  echo "==============================="
  echo "       Uninstall ShowOn"
  echo "==============================="
  read -rp "Are you sure you want to remove ShowOn? [y/N]: " confirm
  if [[ "$confirm" =~ ^[Yy]$ ]]; then
    systemctl stop online-check vnstat-traffic v2ray-traffic sysinfo >/dev/null 2>&1
    systemctl disable online-check vnstat-traffic v2ray-traffic sysinfo >/dev/null 2>&1
    rm -f "$SERVICE_ONLINE" "$SERVICE_VNSTAT" "$SERVICE_V2RAY" "$SERVICE_SYSINFO"
    rm -rf "$INSTALL_DIR" "$WWW_DIR"
    rm -f /etc/nginx/sites-available/showon /etc/nginx/sites-enabled/showon
    rm -f /usr/local/bin/showon
    systemctl reload nginx
    echo -e "${GREEN}[OK]${NC} ShowOn has been uninstalled successfully."
  else
    echo -e "${YELLOW}[CANCELLED]${NC} Uninstall aborted."
  fi
  press
}

# =====================================================
# ฟังก์ชันตรวจสอบสถานะระบบ
# =====================================================
check_status() {
  clear
  echo "==============================="
  echo "         ShowOn Status"
  echo "==============================="
  systemctl status nginx | grep Active
  echo ""
  echo "[ Services ]"
  for svc in online-check vnstat-traffic v2ray-traffic sysinfo; do
    echo -n "- $svc: "
    if systemctl is-active --quiet "$svc"; then
      echo -e "${GREEN}Running${NC}"
    else
      echo -e "${RED}Stopped${NC}"
    fi
  done
  echo ""
  echo "Access URL: ${CYAN}http://${IP_PUBLIC}:${SHOWON_PORT}/server/${NC}"
  press
}

# =====================================================
# เมนูหลัก
# =====================================================
main_menu() {
  while true; do
    clear
    echo "============================================"
    echo "          SHOWON MANAGEMENT SCRIPT          "
    echo "============================================"
    echo "1. Install ShowOn Script"
    echo "2. Uninstall ShowOn"
    echo "3. Check Status"
    echo "4. Restart Nginx & Services"
    echo "5. Update Script"
    echo "6. Change ShowOn Port"
    echo "7. Setup Swap Memory"
    echo "0. Exit"
    echo "--------------------------------------------"
    read -rp "Select menu [0-7]: " opt

    case $opt in
    1) install_showon ;;
    2) uninstall_showon ;;
    3) check_status ;;
    4)
      echo -e "${CYAN}[INFO]${NC} Restarting services..."
      systemctl restart nginx online-check vnstat-traffic v2ray-traffic sysinfo
      echo -e "${GREEN}[OK]${NC} All services restarted."
      press
      ;;
    5)
      echo -e "${CYAN}[INFO]${NC} Updating ShowOn script..."
      download_or_die "$SRC_ONLINE" "$SCRIPT_ONLINE"
      download_or_die "$SRC_VNSTAT" "$SCRIPT_VNSTAT"
      download_or_die "$SRC_V2RAY" "$SCRIPT_V2RAY"
      download_or_die "$SRC_SYSINFO" "$SCRIPT_SYSINFO"
      echo -e "${GREEN}[OK]${NC} All scripts updated."
      press
      ;;
    6) change_port ;;
    7) setup_swap ;;
    0)
      echo -e "${CYAN}[INFO]${NC} Exiting..."
      exit 0
      ;;
    *)
      echo -e "${RED}[ERROR]${NC} Invalid selection."
      press
      ;;
    esac
  done
}

# =====================================================
# เริ่มต้นโปรแกรม
# =====================================================
main_menu
