<FILE:Install>
#!/bin/bash
# =====================================================
# ShowOn Script Manager V.1.0.5
# Main Menu (Install / Uninstall / Update / Debug)
# =====================================================

VERSION="V.1.0.5"
REPO="https://raw.githubusercontent.com/TspKchn/showon/refs/heads/main"

show_menu() {
    clear
    echo "==============================="
    echo "   ShowOn Script Manager $VERSION"
    echo "==============================="
    echo "[OK] You are using the latest version."
    echo "1) Install Script"
    echo "2) Uninstall Script"
    echo "3) Update Script"
    echo "4) Check Debug Log"
    echo "0) Exit"
    echo "==============================="
    read -p "Choose an option [0,1,2,3,4]: " choice
    case $choice in
        1) install_script ;;
        2) uninstall_script ;;
        3) update_script ;;
        4) check_debug ;;
        0) exit 0 ;;
        *) echo "Invalid choice"; sleep 2; show_menu ;;
    esac
}

install_script() {
    echo "[INFO] Installing ShowOn ($VERSION)..."
    apt update -y && apt upgrade -y
    apt install -y curl jq net-tools psmisc nginx iproute2 vnstat

    mkdir -p /var/www/html/server

    # Download sub scripts
    curl -s -o /usr/local/bin/utils.sh   $REPO/utils.sh
    curl -s -o /usr/local/bin/online-check.sh   $REPO/online-check.sh
    curl -s -o /usr/local/bin/vnstat-traffic.sh $REPO/vnstat-traffic.sh
    curl -s -o /usr/local/bin/v2ray-traffic.sh  $REPO/v2ray-traffic.sh
    curl -s -o /usr/local/bin/sysinfo.sh        $REPO/sysinfo.sh

    chmod +x /usr/local/bin/*.sh

    # Create systemd services
    cat >/etc/systemd/system/online-check.service <<EOF
[Unit]
Description=ShowOn Online Users JSON Generator
After=network.target

[Service]
ExecStart=/bin/bash -lc "while true; do /usr/local/bin/online-check.sh; sleep 5; done"
Restart=always

[Install]
WantedBy=multi-user.target
EOF

    cat >/etc/systemd/system/vnstat-traffic.service <<EOF
[Unit]
Description=ShowOn vnStat + V2Ray Traffic JSON Generator
After=network.target

[Service]
ExecStart=/bin/bash -lc "while true; do /usr/local/bin/vnstat-traffic.sh; sleep 60; done"
Restart=always

[Install]
WantedBy=multi-user.target
EOF

    cat >/etc/systemd/system/v2ray-traffic.service <<EOF
[Unit]
Description=ShowOn V2Ray Traffic Collector
After=network.target

[Service]
ExecStart=/bin/bash -lc "while true; do /usr/local/bin/v2ray-traffic.sh; sleep 60; done"
Restart=always

[Install]
WantedBy=multi-user.target
EOF

    cat >/etc/systemd/system/sysinfo.service <<EOF
[Unit]
Description=ShowOn System Info Generator
After=network.target

[Service]
ExecStart=/bin/bash -lc "while true; do /usr/local/bin/sysinfo.sh; sleep 30; done"
Restart=always

[Install]
WantedBy=multi-user.target
EOF

    systemctl daemon-reexec
    systemctl daemon-reload
    systemctl enable --now online-check.service
    systemctl enable --now vnstat-traffic.service
    systemctl enable --now v2ray-traffic.service
    systemctl enable --now sysinfo.service

    echo "[OK] Installed ShowOn $VERSION"
    echo "[INFO] Open: http://$(hostname -I | awk '{print $1}'):82/server/"
    read -p "Press Enter to return to menu..."
    show_menu
}

uninstall_script() {
    echo "[INFO] Uninstalling ShowOn Script..."
    systemctl stop online-check.service vnstat-traffic.service v2ray-traffic.service sysinfo.service 2>/dev/null
    systemctl disable online-check.service vnstat-traffic.service v2ray-traffic.service sysinfo.service 2>/dev/null
    rm -f /etc/systemd/system/online-check.service
    rm -f /etc/systemd/system/vnstat-traffic.service
    rm -f /etc/systemd/system/v2ray-traffic.service
    rm -f /etc/systemd/system/sysinfo.service
    rm -f /usr/local/bin/online-check.sh /usr/local/bin/vnstat-traffic.sh /usr/local/bin/v2ray-traffic.sh /usr/local/bin/sysinfo.sh /usr/local/bin/utils.sh
    systemctl daemon-reload
    echo "[SUCCESS] Uninstalled completely."
    read -p "Press Enter to return to menu..."
    show_menu
}

update_script() {
    echo "[INFO] Updating ShowOn Script..."
    curl -s -o /root/Install $REPO/Install
    chmod +x /root/Install
    echo "[SUCCESS] Script updated. Run ./Install again."
    exit 0
}

check_debug() {
    echo "[INFO] Showing debug log..."
    tail -n 50 /var/log/showon-debug.log
    read -p "Press Enter to return to menu..."
    show_menu
}

show_menu
</FILE:Install>
