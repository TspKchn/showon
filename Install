#!/bin/bash
# =====================================================
# ShowOn Installer Script
# Version: V.1.0.0
# Author: TspKchn
# =====================================================

VERSION="V.1.0.0"
REPO_URL="https://raw.githubusercontent.com/TspKchn/showon/refs/heads/main"

SHOWON_CMD="/usr/local/bin/showon"
CONF_FILE="/etc/showon.conf"
WWW_DIR="/var/www/html/server"
SCRIPT_ONLINE="/usr/local/bin/online-check.sh"
SCRIPT_SYSINFO="/usr/local/bin/sysinfo.sh"
SERVICE_ONLINE="/etc/systemd/system/online-check.service"
SERVICE_SYSINFO="/etc/systemd/system/sysinfo.service"

# ðŸŽ¨ Define Colors
RED="\e[31m"
GREEN="\e[32m"
YELLOW="\e[33m"
CYAN="\e[36m"
NC="\e[0m" # No Color

# =====================================================
# Auto Update Function
# =====================================================
check_update_auto() {
    LATEST_VERSION=$(curl -s --max-time 3 "$REPO_URL/Install" | grep -m1 '^VERSION=' | cut -d'"' -f2)

    if [ -z "$LATEST_VERSION" ]; then
        echo -e "${YELLOW}[WARN]${NC} Cannot fetch latest version (skip update check)."
        return 0
    fi

    if [ "$VERSION" != "$LATEST_VERSION" ]; then
        echo -e "${YELLOW}[UPDATE AVAILABLE]${NC} Latest: ${GREEN}$LATEST_VERSION${NC} (Current: ${RED}$VERSION${NC})"
        echo -e "${CYAN}Press Enter to update now, or Ctrl+C to cancel...${NC}"
        read
        curl -o /root/Install -s "$REPO_URL/Install"
        chmod +x /root/Install
        echo -e "${GREEN}[SUCCESS]${NC} Updated to $LATEST_VERSION"
        echo -e "${CYAN}[INFO] Please run 'showon' again to load the new version.${NC}"
        exit 0
    fi
}

# =====================================================
# Menu
# =====================================================
show_menu() {
    clear
    echo -e "${CYAN}==============================="
    echo -e "   ShowOn Script Manager $VERSION"
    echo -e "===============================${NC}"
    check_update_auto
    echo -e "${GREEN}1) Install Script${NC}"
    echo -e "${RED}2) Uninstall Script${NC}"
    echo -e "${YELLOW}0) Exit${NC}"
    echo -e "${CYAN}===============================${NC}"
    read -p "Choose an option [0,1,2]: " choice
    case $choice in
        1) install_script ;;
        2) uninstall_script ;;
        0) exit 0 ;;
        *) echo -e "${RED}[ERROR]${NC} Invalid choice..."; sleep 1; show_menu ;;
    esac
}

# =====================================================
# Install Script
# =====================================================
install_script() {
    echo -e "${CYAN}[INFO]${NC} Installing ShowOn Script $VERSION ..."

    apt update -y && apt upgrade -y
    apt install -y curl jq net-tools psmisc nginx iproute2 ca-certificates

    mkdir -p "$WWW_DIR"
    chmod -R 755 "$WWW_DIR"

    # Ask config
    read -p "Enter 3x-ui IP (default 127.0.0.1): " PANEL_IP
    PANEL_IP=${PANEL_IP:-127.0.0.1}

    read -p "Enter 3x-ui Port (default 88): " PANEL_PORT
    PANEL_PORT=${PANEL_PORT:-88}

    PANEL_URL="https://${PANEL_IP}:${PANEL_PORT}"
    echo -e "${CYAN}[INFO]${NC} Using PANEL_URL = $PANEL_URL"

    read -p "Enter 3x-ui username: " USERNAME
    read -p "Enter 3x-ui password: " PASSWORD

    # Save config
    cat >"$CONF_FILE" <<EOF
PANEL_URL="$PANEL_URL"
USERNAME="$USERNAME"
PASSWORD="$PASSWORD"
WWW_DIR="$WWW_DIR"
EOF
    chmod 600 "$CONF_FILE"

    # ... (à¹‚à¸„à¹‰à¸”à¸ªà¹ˆà¸§à¸™ online-check.sh, sysinfo.sh, services, nginx config, index.html, uninstall à¹€à¸«à¸¡à¸·à¸­à¸™à¸—à¸µà¹ˆà¸œà¸¡à¹ƒà¸«à¹‰à¸à¹ˆà¸­à¸™à¸«à¸™à¹‰à¸²à¸™à¸µà¹‰) ...

    echo -e "${GREEN}[SUCCESS]${NC} Installed ShowOn $VERSION"
    echo -e "${CYAN}[INFO]${NC} Open: http://$(hostname -I | awk '{print $1}'):82/server/"
    read -p "Press Enter to return to menu..." dummy
    show_menu
}

# =====================================================
# Uninstall Script
# =====================================================
uninstall_script() {
    echo -e "${CYAN}[INFO]${NC} Uninstalling ShowOn Script $VERSION ..."

    systemctl stop online-check.service sysinfo.service 2>/dev/null || true
    systemctl disable online-check.service sysinfo.service 2>/dev/null || true

    rm -f "$SERVICE_ONLINE" "$SERVICE_SYSINFO"
    rm -f "$SCRIPT_ONLINE" "$SCRIPT_SYSINFO"
    rm -f "$CONF_FILE"
    rm -rf "$WWW_DIR"
    rm -f /etc/nginx/sites-enabled/server_checker
    rm -f /etc/nginx/sites-available/server_checker

    systemctl daemon-reload
    systemctl restart nginx

    echo -e "${GREEN}[SUCCESS]${NC} Uninstalled ShowOn $VERSION"
    read -p "Press Enter to reboot..." dummy
    reboot
}

# =====================================================
# Create showon command
# =====================================================
cat >"$SHOWON_CMD" <<EOF
#!/bin/bash
echo -e "${CYAN}ShowOn Script Manager $VERSION${NC}"
bash /root/Install
EOF
chmod +x "$SHOWON_CMD"

# Start menu
show_menu
