#!/bin/bash
# =====================================================
# ShowOn Script Manager V.1.0.8 (Full Edition)
# Author : TspKchn + ChatGPT
# =====================================================

# ----------------- เวอร์ชัน -----------------
VERSION="V.1.0.8"

# ----------------- พาธรีโป ------------------
REPO_RAW="https://raw.githubusercontent.com/TspKchn/showon/main"

# ----------------- ซอร์สไฟล์ ----------------
SRC_ONLINE="$REPO_RAW/scripts/online-check.sh"
SRC_VNSTAT="$REPO_RAW/scripts/vnstat-traffic.sh"
SRC_V2RAY="$REPO_RAW/scripts/v2ray-traffic.sh"
SRC_SYSINFO="$REPO_RAW/scripts/sysinfo.sh"
SRC_INDEX="$REPO_RAW/web/index.html"

# ----------------- ตำแหน่งติดตั้ง ----------
WWW_DIR="/var/www/html/server"
BIN_DIR="/usr/local/bin"
CONF_FILE="/etc/showon.conf"
DEBUG_LOG="/var/log/showon-debug.log"

SCRIPT_ONLINE="$BIN_DIR/online-check.sh"
SCRIPT_VNSTAT="$BIN_DIR/vnstat-traffic.sh"
SCRIPT_V2RAY="$BIN_DIR/v2ray-traffic.sh"
SCRIPT_SYSINFO="$BIN_DIR/sysinfo.sh"

SERVICE_ONLINE="/etc/systemd/system/online-check.service"
SERVICE_VNSTAT="/etc/systemd/system/vnstat-traffic.service"
SERVICE_V2RAY="/etc/systemd/system/v2ray-traffic.service"
SERVICE_SYSINFO="/etc/systemd/system/sysinfo.service"

SITE_AV="/etc/nginx/sites-available/showon"
SITE_EN="/etc/nginx/sites-enabled/showon"

# ----------------- สี ------------------------
GREEN="\e[32m"; RED="\e[31m"; YELLOW="\e[33m"; CYAN="\e[36m"; B="\e[1m"; NC="\e[0m"

# =====================================================
# ฟังก์ชันพื้นฐาน
# =====================================================

require_root() {
  if [[ $EUID -ne 0 ]]; then
    echo -e "${RED}[ERROR]${NC} Please run as root."
    exit 1
  fi
}

press() { read -rp "Press Enter to continue..." _; }

# ตรวจจับ NIC
get_nic() {
  ip -o -4 route get 8.8.8.8 2>/dev/null \
    | awk '{for(i=1;i<=NF;i++) if($i=="dev") print $(i+1)}' \
    | head -n1
}

# หมุน log (1MB)
rotate_log() {
  local max=1000000
  if [[ -f "$DEBUG_LOG" && $(stat -c%s "$DEBUG_LOG") -gt $max ]]; then
    mv "$DEBUG_LOG" "$DEBUG_LOG.1"
    : > "$DEBUG_LOG"
  fi
}

# ดึงไฟล์แบบ fail-fast
download_or_die() {
  local url="$1" dst="$2"
  if ! curl -fsSL "$url" -o "$dst"; then
    echo -e "${RED}[ERROR]${NC} Download failed: $url"
    exit 1
  fi
}

# =====================================================
# ตรวจสอบ IP Public (เช็คหลายเว็บ fallback)
# =====================================================
get_public_ip() {
  local ip=""
  for site in "ifconfig.me" "icanhazip.com" "api.ipify.org"; do
    ip=$(curl -s "$site")
    if [[ "$ip" =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
      echo "$ip"
      return
    fi
  done
  # ถ้าไม่เจอ ให้กรอกเอง
  read -rp "ไม่สามารถตรวจสอบ IP Public อัตโนมัติ กรุณากรอก IP ของเครื่อง: " ip
  echo "$ip"
}

# =====================================================
# เขียน Nginx site
# =====================================================
write_nginx() {
  mkdir -p "$WWW_DIR"
  mkdir -p /etc/nginx/sites-available /etc/nginx/sites-enabled

  # ลบ default site
  rm -f /etc/nginx/sites-enabled/default
  rm -f /etc/nginx/sites-available/default

  # Config ใหม่
  cat >"$SITE_AV" <<EOF
server {
    listen 82 default_server;
    server_name _;

    location = / {
        return 302 /server/;
    }

    location /server/ {
        alias $WWW_DIR/;
        index index.html;
        autoindex off;
        add_header Cache-Control "no-store";

        # บังคับ MIME สำหรับ online_app และ online_app.json
location ~ /server/online_app(\.json)?$ {
    default_type application/json;
    add_header Content-Type application/json;
       }
    }
}
EOF

  ln -sf "$SITE_AV" "$SITE_EN"

  if nginx -t; then
    systemctl restart nginx 2>/dev/null || true
  else
    echo -e "${YELLOW}[WARN]${NC} nginx config test failed, forcing restart..."
    systemctl restart nginx 2>/dev/null || true
  fi

  echo -e "${GREEN}[OK]${NC} Nginx is now listening on port :82 (/server/)"
}
# =====================================================
# สถานะ conntrack (โชว์ในเมนู)
conntrack_status() {
  if command -v conntrack >/dev/null 2>&1; then echo "ON"; else echo "OFF"; fi
}

# =====================================================
# แสดงสถานะ Service + สถานะติดตั้ง
# =====================================================
print_status() {
  local stat_nginx="OFF" stat_online="OFF" stat_vnstat="OFF" stat_v2="OFF" stat_sys="OFF"

  systemctl is-active --quiet nginx && stat_nginx="ON"
  [[ -f "$SERVICE_ONLINE" ]] && systemctl is-active --quiet online-check && stat_online="ON"
  [[ -f "$SERVICE_VNSTAT" ]] && systemctl is-active --quiet vnstat-traffic && stat_vnstat="ON"
  [[ -f "$SERVICE_V2RAY" ]] && systemctl is-active --quiet v2ray-traffic && stat_v2="ON"
  [[ -f "$SERVICE_SYSINFO" ]] && systemctl is-active --quiet sysinfo && stat_sys="ON"

  local c_ng=$( [[ "$stat_nginx" == "ON" ]] && echo "$GREEN" || echo "$RED" )
  local c_on=$( [[ "$stat_online" == "ON" ]] && echo "$GREEN" || echo "$RED" )
  local c_vn=$( [[ "$stat_vnstat" == "ON" ]] && echo "$GREEN" || echo "$RED" )
  local c_v2=$( [[ "$stat_v2" == "ON" ]] && echo "$GREEN" || echo "$RED" )
  local c_sy=$( [[ "$stat_sys" == "ON" ]] && echo "$GREEN" || echo "$RED" )
  local c_ct=$( [[ "$(conntrack_status)" == "ON" ]] && echo "$GREEN" || echo "$RED" )

  local installed="${RED}✘ Not Installed  ${NC}"
  if [[ -f "$SCRIPT_ONLINE" || -f "$SCRIPT_VNSTAT" || -f "$SCRIPT_V2RAY" || -f "$SCRIPT_SYSINFO" ]]; then
    installed="${GREEN}✔ Installed  ${NC}"
  fi

  echo "==============================="
  echo "   ShowOn Script Manager ${VERSION}"
  echo "==============================="
  echo -e "$(printf 'NginX   : [%b%s%b]  Online Check : [%b%s%b]\n' "$c_ng" "$stat_nginx" "$NC" "$c_on" "$stat_online" "$NC")"
  echo -e "$(printf 'vnStat  : [%b%s%b]  V2Ray Traffic: [%b%s%b]\n' "$c_vn" "$stat_vnstat" "$NC" "$c_v2" "$stat_v2" "$NC")"
  echo -e "$(printf 'SysInfo : [%b%s%b]  Conntrack    : [%b%s%b]\n' "$c_sy" "$stat_sys" "$NC" "$c_ct" "$(conntrack_status)" "$NC")"
  echo "-------------------------------"
  echo -e "Status: $installed"
  echo "==============================="
}

# =====================================================
# ตรวจจับ AGN-UDP (Hysteria)
# =====================================================
detect_agnudp() {
  local present="0" port=""

  # ตรวจจาก systemd service
  if systemctl list-units --type=service | grep -q 'hysteria'; then
    port=$(ss -tulnp | grep hysteria | awk '{print $5}' | cut -d: -f2 | head -n1)
    [[ -n "$port" ]] && present="1"
  fi

  # ตรวจจาก binary
  if [[ "$present" == "0" && -x "$(command -v hysteria)" ]]; then
    port=$(ss -tulnp | grep hysteria | awk '{print $5}' | cut -d: -f2 | head -n1)
    [[ -n "$port" ]] && present="1"
  fi

  echo "$present|$port"
}

# =====================================================
# ติดตั้ง ShowOn Script
# =====================================================
install_script() {
  echo -e "${CYAN}[INFO]${NC} Installing ShowOn (${VERSION})..."
  apt update -y >/dev/null 2>&1 || true
  apt install -y curl jq net-tools psmisc nginx iproute2 ca-certificates vnstat conntrack >/dev/null 2>&1 || true

  # ตั้งค่า conntrack UDP timeout
  sysctl -w net.netfilter.nf_conntrack_udp_timeout=5 >/dev/null 2>&1 || true
  sysctl -w net.netfilter.nf_conntrack_udp_timeout_stream=5 >/dev/null 2>&1 || true
  if ! grep -q "nf_conntrack_udp_timeout" /etc/sysctl.conf; then
    echo "net.netfilter.nf_conntrack_udp_timeout=5" >> /etc/sysctl.conf
    echo "net.netfilter.nf_conntrack_udp_timeout_stream=5" >> /etc/sysctl.conf
    sysctl -p >/dev/null 2>&1 || true
  fi

  # เปิด vnstat
  systemctl enable vnstat >/dev/null 2>&1 || true
  systemctl start vnstat >/dev/null 2>&1 || true

  mkdir -p "$WWW_DIR" "$BIN_DIR" "$(dirname "$DEBUG_LOG")"
  rotate_log

  # ตรวจ AGN-UDP (Hysteria)
  local AGN_PRESENT="0" AGN_PORT=""
  if [[ -f /etc/hysteria/config.json ]]; then
    AGN_PORT=$(jq -r '.listen // empty' /etc/hysteria/config.json 2>/dev/null \
      | sed -E 's/^\[::\]://; s/^[^:]*://; s/[^0-9].*$//')
    if [[ -n "$AGN_PORT" && "$AGN_PORT" =~ ^[0-9]+$ ]]; then
      AGN_PRESENT="1"
      echo -e "${GREEN}[OK]${NC} AGN-UDP (Hysteria) detected from config → port: ${B}${AGN_PORT}${NC}"
    else
      echo -e "${YELLOW}[WARN]${NC} Found hysteria config but no valid port"
    fi
  fi

  if [[ "$AGN_PRESENT" == "0" ]]; then
    IFS='|' read -r AGN_PRESENT AGN_PORT <<<"$(detect_agnudp)"
    if [[ "$AGN_PRESENT" == "1" ]]; then
      echo -e "${GREEN}[OK]${NC} AGN-UDP (Hysteria) detected via systemd/binary → port: ${B}${AGN_PORT}${NC}"
    else
      echo -e "${CYAN}[INFO]${NC} AGN-UDP (Hysteria) not found → skipped"
    fi
  fi

  # ตรวจ 3x-ui / Xray-Core
  local PANEL_URL XUI_USER XUI_PASS
  if [[ -d /etc/x-ui ]]; then
    echo -e "${CYAN}[INFO]${NC} พบ 3x-ui → ตั้งค่าการเชื่อมต่อ API"
    read -rp "3X-UI URL (copy login link): " PANEL_URL
    PANEL_URL="$(echo "$PANEL_URL" | sed 's:/*$::')"
    read -rp "3X-UI Username: " XUI_USER
    read -rp "3X-UI Password: " XUI_PASS
  else
    echo -e "${CYAN}[INFO]${NC} พบ Xray-Core → ข้ามการตั้งค่า 3x-ui"
    PANEL_URL="" XUI_USER="" XUI_PASS=""
  fi

  # Limit
  read -rp "Limit User Online (Default: 2000): " LIMIT
  LIMIT=${LIMIT:-2000}

  # เขียน config
  NIC=$(get_nic)
  [[ -z "$NIC" ]] && NIC=$(ip -o -4 addr show up scope global | awk '{print $2}' | head -n1)
  [[ -z "$NIC" ]] && NIC="eth0"
  cat >"$CONF_FILE" <<EOF
VERSION="${VERSION}"
WWW_DIR="$WWW_DIR"
LIMIT=${LIMIT}
DEBUG_LOG="$DEBUG_LOG"

PANEL_URL="$PANEL_URL"
XUI_USER="$XUI_USER"
XUI_PASS="$XUI_PASS"

NET_IFACE="$NIC"

# --- AGN-UDP (Hysteria) ---
AGN_PRESENT=$AGN_PRESENT
AGN_PORT="$AGN_PORT"
EOF
  chmod 600 "$CONF_FILE"

  # ดาวน์โหลดสคริปต์จาก repo
  download_or_die "$SRC_ONLINE" "$SCRIPT_ONLINE"
  download_or_die "$SRC_VNSTAT" "$SCRIPT_VNSTAT"
  download_or_die "$SRC_V2RAY"  "$SCRIPT_V2RAY"
  download_or_die "$SRC_SYSINFO" "$SCRIPT_SYSINFO"
  chmod +x "$SCRIPT_ONLINE" "$SCRIPT_VNSTAT" "$SCRIPT_V2RAY" "$SCRIPT_SYSINFO"

  mkdir -p "$WWW_DIR"
  download_or_die "$SRC_INDEX" "$WWW_DIR/index.html"
  chmod 644 "$WWW_DIR/index.html"

  # สร้าง Nginx config
  write_nginx
  systemctl enable --now nginx >/dev/null 2>&1 || true

  # สร้าง systemd services
  cat >"$SERVICE_ONLINE" <<'EOF'
[Unit]
Description=ShowOn Online Users JSON Generator
After=network-online.target
Wants=network-online.target

[Service]
Type=simple
ExecStart=/bin/bash -c 'while true; do /usr/local/bin/online-check.sh; sleep 5; done'
Restart=always
RestartSec=2

[Install]
WantedBy=multi-user.target
EOF

  cat >"$SERVICE_VNSTAT" <<'EOF'
[Unit]
Description=ShowOn vnStat + V2Ray Traffic JSON Generator
After=network-online.target
Wants=network-online.target

[Service]
Type=simple
ExecStart=/bin/bash -c 'while true; do /usr/local/bin/vnstat-traffic.sh; sleep 5; done'
Restart=always
RestartSec=2

[Install]
WantedBy=multi-user.target
EOF

  cat >"$SERVICE_V2RAY" <<'EOF'
[Unit]
Description=ShowOn V2Ray-Only Traffic JSON Generator
After=network-online.target
Wants=network-online.target

[Service]
Type=simple
ExecStart=/bin/bash -c 'while true; do /usr/local/bin/v2ray-traffic.sh; sleep 5; done'
Restart=always
RestartSec=2

[Install]
WantedBy=multi-user.target
EOF

  cat >"$SERVICE_SYSINFO" <<'EOF'
[Unit]
Description=ShowOn System Info JSON Generator
After=network-online.target
Wants=network-online.target

[Service]
Type=simple
ExecStart=/bin/bash -c 'while true; do /usr/local/bin/sysinfo.sh; sleep 5; done'
Restart=always
RestartSec=2

[Install]
WantedBy=multi-user.target
EOF

  # เริ่มใช้งาน services
  systemctl daemon-reload
  systemctl enable --now online-check.service vnstat-traffic.service v2ray-traffic.service sysinfo.service

  echo -e "${GREEN}[OK]${NC} Installed ShowOn ${VERSION}"
  echo -e "${CYAN}[INFO]${NC} Open: http://$(hostname -I | awk '{print $1}'):82/server/"
  press
}

# =====================================================
# ถอนการติดตั้ง
# =====================================================
uninstall_script() {
  echo -e "${CYAN}[INFO]${NC} Uninstalling ShowOn Script (Full Clean)..."

  # หยุดและปิด service ทั้งหมด
  systemctl stop online-check.service vnstat-traffic.service v2ray-traffic.service sysinfo.service 2>/dev/null || true
  systemctl disable online-check.service vnstat-traffic.service v2ray-traffic.service sysinfo.service 2>/dev/null || true

  # ลบ service files
  rm -f "$SERVICE_ONLINE" "$SERVICE_VNSTAT" "$SERVICE_V2RAY" "$SERVICE_SYSINFO"
  systemctl daemon-reload

  # ลบ script และ config
  rm -f "$SCRIPT_ONLINE" "$SCRIPT_VNSTAT" "$SCRIPT_V2RAY" "$SCRIPT_SYSINFO"
  rm -f "$CONF_FILE" "$DEBUG_LOG"

  # ลบ nginx site
  rm -f "$SITE_AV" "$SITE_EN"
  if systemctl is-active --quiet nginx; then
    systemctl reload nginx 2>/dev/null || true
  fi

  # ถอน nginx และ conntrack
  apt purge -y nginx conntrack >/dev/null 2>&1 || true
  apt autoremove -y >/dev/null 2>&1 || true

  # คืนค่า conntrack UDP timeout
  sed -i '/^net\.netfilter\.nf_conntrack_udp_timeout=/d' /etc/sysctl.conf
  sed -i '/^net\.netfilter\.nf_conntrack_udp_timeout_stream=/d' /etc/sysctl.conf
  sysctl -p >/dev/null 2>&1 || true

  echo -e "${GREEN}[SUCCESS]${NC} Uninstalled completely (ShowOn + conntrack removed)."
}
# =====================================================
# อัปเดตสคริปต์
# =====================================================
update_script() {
  echo -e "${CYAN}[INFO]${NC} Updating all ShowOn components..."
  rotate_log

  download_or_die "$SRC_ONLINE?$(date +%s)" "$SCRIPT_ONLINE"
  download_or_die "$SRC_VNSTAT?$(date +%s)" "$SCRIPT_VNSTAT"
  download_or_die "$SRC_V2RAY?$(date +%s)" "$SCRIPT_V2RAY"
  download_or_die "$SRC_SYSINFO?$(date +%s)" "$SCRIPT_SYSINFO"
  chmod +x "$SCRIPT_ONLINE" "$SCRIPT_VNSTAT" "$SCRIPT_V2RAY" "$SCRIPT_SYSINFO"

  download_or_die "$SRC_INDEX?$(date +%s)" "$WWW_DIR/index.html"
  chmod 644 "$WWW_DIR/index.html"

  local TMP_SCRIPT="/tmp/Install.$$"
  if curl -fsSL "$REPO_RAW/Install?$(date +%s)" -o "$TMP_SCRIPT"; then
    mv "$TMP_SCRIPT" /root/Install
    chmod +x /root/Install
    echo -e "${GREEN}[OK]${NC} Updated Install script."
  else
    echo -e "${RED}[ERROR]${NC} Failed to update Install script."
  fi

  systemctl daemon-reload
  systemctl restart online-check vnstat-traffic v2ray-traffic sysinfo 2>/dev/null || true
  echo -e "${GREEN}[OK]${NC} Update completed."
}

# =====================================================
# Debug log และเปลี่ยน Limit
# =====================================================
check_debug() {
  rotate_log
  if [[ -f "$DEBUG_LOG" ]]; then
    tail -n 100 "$DEBUG_LOG"
  else
    echo "No debug log yet."
  fi
  press
}

change_limit() {
  if [[ ! -f "$CONF_FILE" ]]; then
    echo -e "${RED}[ERROR]${NC} Config file not found!"
    press; return
  fi

  source "$CONF_FILE"
  echo -e "${CYAN}[INFO]${NC} Current Limit User Online: ${LIMIT:-2000}"
  read -rp "Enter new Limit User Online: " NEW_LIMIT
  if [[ -z "$NEW_LIMIT" ]]; then
    echo -e "${YELLOW}[WARN]${NC} Limit not changed"
    press; return
  fi

  sed -i "s/^LIMIT=.*/LIMIT=${NEW_LIMIT}/" "$CONF_FILE"
  echo -e "${GREEN}[OK]${NC} Limit updated to ${NEW_LIMIT} users"
  press
}

# =====================================================
# Setup Swap
# =====================================================
setup_swap() {
  echo -e "${CYAN}[INFO]${NC} Auto Swap Wizard"

  local ram_kb=$(grep MemTotal /proc/meminfo | awk '{print $2}')
  local ram_mb=$(( ram_kb / 1024 ))
  local swap_mb

  if (( ram_mb <= 1024 )); then swap_mb=$(( ram_mb * 2 ))
  elif (( ram_mb <= 4096 )); then swap_mb=$(( ram_mb * 1 ))
  elif (( ram_mb <= 16384 )); then swap_mb=4096
  else swap_mb=8192
  fi

  if swapon --show | awk 'NR>1{print $1}' | grep -q .; then
    echo -e "${YELLOW}[WARN]${NC} Swap already exists"
    read -rp "Overwrite existing swap? (Y/n): " ans
    if [[ -z "$ans" || "$ans" =~ ^[Yy]$ ]]; then
      swapoff -a || true
      sed -i '/swapfile showon/d' /etc/fstab || true
    else
      echo -e "${GREEN}[OK]${NC} Skipping swap creation"
      press; return
    fi
  fi

  echo -e "${CYAN}[INFO]${NC} Creating swapfile ${swap_mb} MiB..."
  fallocate -l "${swap_mb}M" /swapfile || dd if=/dev/zero of=/swapfile bs=1M count="${swap_mb}"
  chmod 600 /swapfile
  mkswap /swapfile >/dev/null
  swapon /swapfile
  if ! grep -q "swapfile showon" /etc/fstab; then
    echo "/swapfile none swap sw 0 0 # swapfile showon" >> /etc/fstab
  fi

  sysctl -w vm.swappiness=10 >/dev/null
  sysctl -w vm.vfs_cache_pressure=100 >/dev/null
  if ! grep -q '^vm.swappiness' /etc/sysctl.conf; then echo "vm.swappiness=10" >> /etc/sysctl.conf; fi
  if ! grep -q '^vm.vfs_cache_pressure' /etc/sysctl.conf; then echo "vm.vfs_cache_pressure=100" >> /etc/sysctl.conf; fi

  echo -e "${GREEN}[OK]${NC} Swap active:"
  free -h
  systemctl restart online-check.service vnstat-traffic.service v2ray-traffic.service sysinfo.service 2>/dev/null || true
  echo -e "${GREEN}[OK]${NC} Restarted ShowOn services."
  press
}

# =====================================================
# เมนูหลัก
# =====================================================
show_menu() {
  clear
  print_status
  check_update
  echo "============================================"
  echo "          SHOWON MANAGEMENT SCRIPT"
  echo "============================================"
  echo "1) Install ShowOn Script"
  echo "2) Uninstall ShowOn"
  echo "3) Check Status"
  echo "4) Restart Nginx & Services"
  echo "5) Update Script"
  echo "6) Change ShowOn Port"
  echo "7) Setup Swap Memory"
  echo "0) Exit"
  echo "--------------------------------------------"
  read -rp "Select menu [0-7]: " choice
  case "$choice" in
    1) install_script ;;
    2) uninstall_script ;;
    3) print_status ; press ;;
    4) systemctl restart nginx online-check vnstat-traffic v2ray-traffic sysinfo 2>/dev/null || true ; press ;;
    5) update_script ;;
    6) change_limit ;;
    7) setup_swap ;;
    0) exit 0 ;;
    *) echo -e "${RED}[ERROR]${NC} Invalid choice" ; sleep 1 ;;
  esac
  show_menu
}

# =====================================================
# Main
# =====================================================
require_root
show_menu
