#!/bin/bash
# =====================================================
# ShowOn Script Manager V.1.0.9 (GIVPN-compatible)
# Author : TspKchn + ChatGPT
# - WWW_DIR set to /home/vps/public_html/server
# - Appends nginx server block into /etc/nginx/conf.d/vps.conf (no overwrite)
# - Local version saved at /etc/showon-version
# =====================================================

# ----------------- เวอร์ชัน -----------------
VERSION="V.1.0.9"

# ----------------- พาธรีโป ------------------
REPO_RAW="https://raw.githubusercontent.com/TspKchn/showon/main"

# ----------------- ซอร์สไฟล์ ----------------
SRC_ONLINE="$REPO_RAW/scripts/online-check.sh"
SRC_VNSTAT="$REPO_RAW/scripts/vnstat-traffic.sh"
SRC_V2RAY="$REPO_RAW/scripts/v2ray-traffic.sh"
SRC_SYSINFO="$REPO_RAW/scripts/sysinfo.sh"
SRC_INDEX="$REPO_RAW/web/index.html"

# ----------------- ตำแหน่งติดตั้ง ----------
WWW_DIR="/home/vps/public_html/server"
BIN_DIR="/usr/local/bin"
CONF_FILE="/etc/showon.conf"
DEBUG_LOG="/var/log/showon-debug.log"
VERSION_FILE="/etc/showon-version"

SCRIPT_ONLINE="$BIN_DIR/online-check.sh"
SCRIPT_VNSTAT="$BIN_DIR/vnstat-traffic.sh"
SCRIPT_V2RAY="$BIN_DIR/v2ray-traffic.sh"
SCRIPT_SYSINFO="$BIN_DIR/sysinfo.sh"

SERVICE_ONLINE="/etc/systemd/system/online-check.service"
SERVICE_VNSTAT="/etc/systemd/system/vnstat-traffic.service"
SERVICE_V2RAY="/etc/systemd/system/v2ray-traffic.service"
SERVICE_SYSINFO="/etc/systemd/system/sysinfo.service"

VPS_CONF="/etc/nginx/conf.d/vps.conf"

# ----------------- สี ------------------------
GREEN="\e[32m"; RED="\e[31m"; YELLOW="\e[33m"; CYAN="\e[36m"; B="\e[1m"; NC="\e[0m"

# =====================================================
# ฟังก์ชันพื้นฐาน
# =====================================================

require_root() {
  if [[ $EUID -ne 0 ]]; then
    echo -e "${RED}[ERROR]${NC} Please run as root."
    exit 1
  fi
}

press() { read -rp "Press Enter to continue..." _; }

# ตรวจจับ NIC
get_nic() {
  ip -o -4 route get 8.8.8.8 2>/dev/null \
    | awk '{for(i=1;i<=NF;i++) if($i=="dev") print $(i+1)}' \
    | head -n1
}

# ตรวจจับ Public IP
get_public_ip() {
  for url in "https://ifconfig.me/ip" "https://ipinfo.io/ip" "https://icanhazip.com"; do
    ip=$(curl -fsSL "$url" 2>/dev/null | tr -d '[:space:]')
    if [[ -n "$ip" ]]; then
      echo "$ip"
      return
    fi
  done
  # fallback ถ้าไม่ได้
  echo "127.0.0.1"
}

# อ่าน local version (เก็บไว้ที่ /etc/showon-version)
get_local_version() {
  if [[ -f "$VERSION_FILE" ]]; then
    cat "$VERSION_FILE"
  else
    echo "None"
  fi
}

# ตรวจ AGN-UDP แบบปลอดภัย
detect_agnudp() {
  # คืนค่าในรูปแบบ: "HAS_AGN|PORT"
  # ถ้าไม่มี → "0|"
  local port=""
  if systemctl list-units --type=service 2>/dev/null | grep -qi "hysteria"; then
    port=$(ss -tulnp 2>/dev/null | awk '/hysteria/ && /udp/ {print $5}' | head -n1 | sed 's/.*://')
    if [[ -n "$port" && "$port" =~ ^[0-9]+$ ]]; then
      echo "1|$port"
      return
    fi
    echo "1|"
    return
  fi
  echo "0|"
}

# หมุน log (1MB)
rotate_log() {
  local max=1000000
  if [[ -f "$DEBUG_LOG" && $(stat -c%s "$DEBUG_LOG") -gt $max ]]; then
    mv "$DEBUG_LOG" "$DEBUG_LOG.1"
    : > "$DEBUG_LOG"
  fi
}

# ดึงไฟล์แบบ fail-fast
download_or_die() {
  local url="$1" dst="$2"
  # สร้างพาธปลายทางถ้าเป็นไดเรกทอรี
  mkdir -p "$(dirname "$dst")"
  if ! curl -fsSL "$url" -o "$dst"; then
    echo -e "${RED}[ERROR]${NC} Download failed: $url"
    exit 1
  fi
}

# สร้างคำสั่ง global "showon" ที่ดึงสคริปต์ล่าสุดจาก GitHub
install_showon_command() {
  cat > /usr/local/bin/showon <<'SH'
#!/bin/bash
bash <(curl -fsSL https://raw.githubusercontent.com/TspKchn/showon/main/Install)
SH
  chmod +x /usr/local/bin/showon
}

# เขียน Nginx ลง /etc/nginx/conf.d/vps.conf (append server block ใหม่เท่านั้น)
# ใช้โครงสร้าง /server/ + JSON + online_app, online_app.json ฯลฯ
write_nginx() {
  local port="${1:-82}"  # default 82
  local webpath="$WWW_DIR"
  mkdir -p "$(dirname "$VPS_CONF")"
  mkdir -p "$webpath"
  mkdir -p /var/log/nginx

  # ถ้าไม่มีไฟล์ vps.conf ให้สร้าง
  if [[ ! -f "$VPS_CONF" ]]; then
    echo "# vps.conf (created by ShowOn Installer)" > "$VPS_CONF"
  fi

  # ถ้ามีบล็อกอยู่แล้ว → ไม่เพิ่มซ้ำ (ตามตัวเลือกของคุณ)
  if grep -q "==== SHOWON AUTOCONFIG BEGIN ====" "$VPS_CONF"; then
    echo -e "${YELLOW}[WARN]${NC} ShowOn Nginx block already exists in $VPS_CONF, skipping append."
  else
    echo -e "${CYAN}[INFO]${NC} Appending ShowOn server block to $VPS_CONF (port $port)..."
    # ใส่ heredoc โดยต้อง escape $ ที่ต้องการให้ nginx ใช้จริง
    cat >> "$VPS_CONF" <<EOF

# ==== SHOWON AUTOCONFIG BEGIN ====
server {
  listen       $port;
  server_name  127.0.0.1 localhost;

  access_log /var/log/nginx/showon-access.log;
  error_log  /var/log/nginx/showon-error.log error;

  # Root ของ ShowOn
  root $webpath;

  # Redirect root → /server/
  location = / {
        return 302 /server/;
  }

  # Main Directory for ShowOn
  location /server/ {
        alias $webpath/;
        index index.html;
        autoindex off;

        # ไฟล์ .json ทั้งหมดต้องเป็น JSON
        location ~* \.(json)$ {
            default_type application/json;
        }

        # ไฟล์ JSON ไม่มีนามสกุล เช่น online_app, sys_info ฯลฯ
        location ~ /server/(online_app|sys_info|v2ray_traffic|vnstat_traffic)$ {
            default_type application/json;
        }
  }

  # PHP handling if ever needed (keeps compatibility)
  location ~ \.php\$ {
    include /etc/nginx/fastcgi_params;
    fastcgi_pass 127.0.0.1:9000;
    fastcgi_index index.php;
    fastcgi_param SCRIPT_FILENAME \$document_root\$fastcgi_script_name;
  }
}
# ==== SHOWON AUTOCONFIG END ====
EOF
  fi

  # ทดสอบ config และ reload nginx แบบปลอดภัย
  if nginx -t >/dev/null 2>&1; then
    systemctl reload nginx >/dev/null 2>&1 || systemctl restart nginx >/dev/null 2>&1 || true
    echo -e "${GREEN}[OK]${NC} Nginx reloaded successfully."
  else
    echo -e "${RED}[ERROR]${NC} Nginx config invalid! Check $VPS_CONF"
  fi

  echo -e "${GREEN}[OK]${NC} ShowOn should be available on port: $port"
}

# สถานะ conntrack (ไว้โชว์ในเมนู)
conntrack_status() {
  if command -v conntrack >/dev/null 2>&1; then echo "ON"; else echo "OFF"; fi
}

# ตรวจอัปเดตจากรีโมต (อ่าน VERSION จากไฟล์ Install บน GitHub)
check_update() {
  local install_raw remote local_ver ans
  install_raw="$(curl -fsSL "$REPO_RAW/Install" || true)"
  if [[ -z "$install_raw" ]]; then
    echo -e "${YELLOW}[WARN]${NC} ไม่สามารถเช็คเวอร์ชันจาก GitHub ได้"
    return
  fi

  remote="$(printf '%s' "$install_raw" | grep -m1 '^VERSION=' | cut -d'"' -f2)"
  if [[ -z "$remote" ]]; then
    echo -e "${YELLOW}[WARN]${NC} พบไฟล์ Install ใน GitHub แต่หา VERSION ไม่เจอ"
    return
  fi

  local_ver="$(get_local_version)"

  echo -e "${CYAN}[INFO]${NC} Local version : ${B}${local_ver}${NC}"
  echo -e "${CYAN}[INFO]${NC} Latest version: ${B}${remote}${NC}"

  # ถ้ายังไม่เคยติดตั้ง ให้ข้ามการ update
  if [[ "$local_ver" == "None" ]]; then
    echo -e "${YELLOW}[INFO]${NC} Script not installed locally. Run 'Install Script' first."
    return
  fi

  if [[ "$local_ver" == "$remote" ]]; then
    echo -e "${GREEN}[OK]${NC} You are using the latest version."
  else
    echo -e "${CYAN}[UPDATE]${NC} มีเวอร์ชันใหม่: ${remote} (ปัจจุบันติดตั้ง: ${local_ver})"
    echo -en "กด Enter เพื่ออัปเดตทันที หรือพิมพ์ ${B}n${NC} เพื่อข้าม: "
    read ans
    if [[ -z "$ans" || "$ans" == "y" || "$ans" == "Y" ]]; then
      update_script
      clear
      print_status
      check_update
      show_menu
    fi
  fi
}

# แสดงสถานะ Service + สถานะติดตั้ง
print_status() {
  local stat_nginx="OFF" stat_online="OFF" stat_vnstat="OFF" stat_v2="OFF" stat_sys="OFF"

  systemctl is-active --quiet nginx && stat_nginx="ON"
  [[ -f "$SERVICE_ONLINE" ]] && systemctl is-active --quiet online-check && stat_online="ON"
  [[ -f "$SERVICE_VNSTAT" ]] && systemctl is-active --quiet vnstat-traffic && stat_vnstat="ON"
  [[ -f "$SERVICE_V2RAY" ]] && systemctl is-active --quiet v2ray-traffic && stat_v2="ON"
  [[ -f "$SERVICE_SYSINFO" ]] && systemctl.is-active --quiet sysinfo 2>/dev/null && stat_sys="ON" || stat_sys="${stat_sys}"

  local c_ng=$( [[ "$stat_nginx" == "ON" ]] && echo "$GREEN" || echo "$RED" )
  local c_on=$( [[ "$stat_online" == "ON" ]] && echo "$GREEN" || echo "$RED" )
  local c_vn=$( [[ "$stat_vnstat" == "ON" ]] && echo "$GREEN" || echo "$RED" )
  local c_v2=$( [[ "$stat_v2" == "ON" ]] && echo "$GREEN" || echo "$RED" )
  local c_sy=$( [[ "$stat_sys" == "ON" ]] && echo "$GREEN" || echo "$RED" )
  local c_ct=$( [[ "$(conntrack_status)" == "ON" ]] && echo "$GREEN" || echo "$RED" )

  local installed="${RED}✘ Not Installed  ${NC}"
  if [[ -f "$SCRIPT_ONLINE" || -f "$SCRIPT_VNSTAT" || -f "$SCRIPT_V2RAY" || -f "$SCRIPT_SYSINFO" ]]; then
    installed="${GREEN}✔ Installed  ${NC}"
  fi

  echo "==============================="
  echo "   ShowOn Script Manager ${VERSION}"
  echo "==============================="
  echo -e "$(printf 'NginX   : [%b%s%b]  Online Check : [%b%s%b]\n' "$c_ng" "$stat_nginx" "$NC" "$c_on" "$stat_online" "$NC")"
  echo -e "$(printf 'vnStat  : [%b%s%b]  V2Ray Traffic: [%b%s%b]\n' "$c_vn" "$stat_vnstat" "$NC" "$c_v2" "$stat_v2" "$NC")"
  echo -e "$(printf 'SysInfo : [%b%s%b]  Conntrack    : [%b%s%b]\n' "$c_sy" "$stat_sys" "$NC" "$c_ct" "$(conntrack_status)" "$NC")"
  echo "-------------------------------"
  echo -e "Status: $installed"
  echo "==============================="
}

# =====================================================
# ติดตั้ง
# =====================================================

install_script() {
  echo -e "${CYAN}[INFO]${NC} Installing ShowOn (${VERSION})..."

  # Update packages
  echo -e "${CYAN}[INFO]${NC} Updating system packages..."
  apt update -y >/dev/null 2>&1 || true

  # Install dependencies
  echo -e "${CYAN}[INFO]${NC} Installing dependencies..."
  apt install -y curl jq net-tools psmisc nginx iproute2 ca-certificates vnstat conntrack >/dev/null 2>&1 || true

  # Tuning conntrack UDP timeout
  echo -e "${CYAN}[INFO]${NC} Tuning conntrack UDP timeout → 5s"
  sysctl -w net.netfilter.nf_conntrack_udp_timeout=5 >/dev/null 2>&1 || true
  sysctl -w net.netfilter.nf_conntrack_udp_timeout_stream=5 >/dev/null 2>&1 || true

  if ! grep -q "nf_conntrack_udp_timeout" /etc/sysctl.conf 2>/dev/null; then
    echo "net.netfilter.nf_conntrack_udp_timeout=5" >> /etc/sysctl.conf
    echo "net.netfilter.nf_conntrack_udp_timeout_stream=5" >> /etc/sysctl.conf
    sysctl -p >/dev/null 2>&1 || true
  fi

  # Enable vnstat
  systemctl enable vnstat >/dev/null 2>&1 || true
  systemctl start vnstat  >/dev/null 2>&1 || true

  mkdir -p "$WWW_DIR" "$BIN_DIR" "$(dirname "$DEBUG_LOG")"
  rotate_log

  # detect hysteria
  local AGN_PRESENT="0" AGN_PORT=""
  if [[ -f /etc/hysteria/config.json ]]; then
    AGN_PORT=$(jq -r '.listen // empty' /etc/hysteria/config.json 2>/dev/null \
      | sed -E 's/^\[::\]://; s/^[^:]*://; s/[^0-9].*$//')
    if [[ -n "$AGN_PORT" && "$AGN_PORT" =~ ^[0-9]+$ ]]; then
      AGN_PRESENT="1"
      echo -e "${GREEN}[OK]${NC} AGN-UDP (Hysteria) detected from config → port: ${B}${AGN_PORT}${NC}"
    else
      echo -e "${YELLOW}[WARN]${NC} Found hysteria config but no valid port"
    fi
  fi

  if [[ "$AGN_PRESENT" == "0" ]]; then
    IFS='|' read -r AGN_PRESENT AGN_PORT <<<"$(detect_agnudp)"
    if [[ "$AGN_PRESENT" == "1" ]]; then
      echo -e "${GREEN}[OK]${NC} AGN-UDP (Hysteria) detected via systemd/binary → port: ${B}${AGN_PORT}${NC}"
    else
      echo -e "${CYAN}[INFO]${NC} AGN-UDP (Hysteria) not found → skipped"
    fi
  fi

  # check x-ui
  local PANEL_URL XUI_USER XUI_PASS
  if [[ -d /etc/x-ui ]]; then
    echo -e "${CYAN}[INFO]${NC} Detected 3x-ui → configure API access"
    read -rp "3X-UI URL (copy login link) : " PANEL_URL
    PANEL_URL="$(echo "$PANEL_URL" | sed 's:/*$::')"
    read -rp "3X-UI Username: " XUI_USER
    read -rp "3X-UI Password: " XUI_PASS
  else
    PANEL_URL=""
    XUI_USER=""
    XUI_PASS=""
  fi

  # Limit
  read -rp "Limit User Online (Default: 2000): " LIMIT
  LIMIT=${LIMIT:-2000}

  # NIC
  NIC=$(get_nic)
  [[ -z "$NIC" ]] && NIC=$(ip -o -4 addr show up scope global | awk '{print $2}' | head -n1)
  [[ -z "$NIC" ]] && NIC="eth0"

  # write conf
  cat >"$CONF_FILE" <<EOF
VERSION="${VERSION}"
WWW_DIR="$WWW_DIR"
LIMIT=${LIMIT}
DEBUG_LOG="$DEBUG_LOG"

PANEL_URL="$PANEL_URL"
XUI_USER="$XUI_USER"
XUI_PASS="$XUI_PASS"

NET_IFACE="$NIC"

# --- AGN-UDP (Hysteria) ---
AGN_PRESENT=$AGN_PRESENT
AGN_PORT="$AGN_PORT"
EOF
  chmod 600 "$CONF_FILE"

  # download scripts
  download_or_die "$SRC_ONLINE" "$SCRIPT_ONLINE"
  download_or_die "$SRC_VNSTAT" "$SCRIPT_VNSTAT"
  download_or_die "$SRC_V2RAY" "$SCRIPT_V2RAY"
  download_or_die "$SRC_SYSINFO" "$SCRIPT_SYSINFO"
  chmod +x "$SCRIPT_ONLINE" "$SCRIPT_VNSTAT" "$SCRIPT_V2RAY" "$SCRIPT_SYSINFO"

  # prepare www
  mkdir -p "$WWW_DIR"
  download_or_die "$SRC_INDEX?$(date +%s)" "$WWW_DIR/index.html"
  chmod 644 "$WWW_DIR/index.html"

  # ask port and write nginx block
  read -rp "Enter Nginx Port for ShowOn (Default 82): " PORT
  PORT=${PORT:-82}
  write_nginx "$PORT"
  systemctl enable --now nginx >/dev/null 2>&1 || true

  # systemd services
  cat >"$SERVICE_ONLINE" <<'EOF'
[Unit]
Description=ShowOn Online Users JSON Generator
After=network-online.target
Wants=network-online.target

[Service]
Type=simple
ExecStart=/bin/bash -c 'while true; do /usr/local/bin/online-check.sh; sleep 5; done'
Restart=always
RestartSec=2

[Install]
WantedBy=multi-user.target
EOF

  cat >"$SERVICE_VNSTAT" <<'EOF'
[Unit]
Description=ShowOn vnStat + V2Ray Traffic JSON Generator
After=network-online.target
Wants=network-online.target

[Service]
Type=simple
ExecStart=/bin/bash -c 'while true; do /usr/local/bin/vnstat-traffic.sh; sleep 5; done'
Restart=always
RestartSec=2

[Install]
WantedBy=multi-user.target
EOF

  cat >"$SERVICE_V2RAY" <<'EOF'
[Unit]
Description=ShowOn V2Ray-Only Traffic JSON Generator
After=network-online.target
Wants=network-online.target

[Service]
Type=simple
ExecStart=/bin/bash -c 'while true; do /usr/local/bin/v2ray-traffic.sh; sleep 5; done'
Restart=always
RestartSec=2

[Install]
WantedBy=multi-user.target
EOF

  cat >"$SERVICE_SYSINFO" <<'EOF'
[Unit]
Description=ShowOn System Info JSON Generator
After=network-online.target
Wants=network-online.target

[Service]
Type=simple
ExecStart=/bin/bash -c 'while true; do /usr/local/bin/sysinfo.sh; sleep 5; done'
Restart=always
RestartSec=2

[Install]
WantedBy=multi-user.target
EOF

  systemctl daemon-reload
  systemctl enable --now online-check.service vnstat-traffic.service v2ray-traffic.service sysinfo.service

  # create showon command
  install_showon_command

  # write local version file
  echo "$VERSION" > "$VERSION_FILE"

  echo -e "${GREEN}[OK]${NC} Installed ShowOn ${VERSION}"
  PUB_IP=$(get_public_ip)
  echo -e "${CYAN}[INFO]${NC} Open: http://$PUB_IP:$PORT/server/"
  press
}

# =====================================================
# ถอนการติดตั้ง
# =====================================================

uninstall_script() {
  echo -e "${CYAN}[INFO]${NC} Uninstalling ShowOn Script (Full Clean)..."

  # stop and disable services
  systemctl stop online-check.service vnstat-traffic.service v2ray-traffic.service sysinfo.service 2>/dev/null || true
  systemctl disable online-check.service vnstat-traffic.service v2ray-traffic.service sysinfo.service 2>/dev/null || true

  # remove service files
  rm -f "$SERVICE_ONLINE" "$SERVICE_VNSTAT" "$SERVICE_V2RAY" "$SERVICE_SYSINFO"
  systemctl daemon-reload

  # remove scripts and config
  rm -f "$SCRIPT_ONLINE" "$SCRIPT_VNSTAT" "$SCRIPT_V2RAY" "$SCRIPT_SYSINFO"
  rm -f "$CONF_FILE" "$DEBUG_LOG" "$VERSION_FILE"

  # remove nginx block from vps.conf
  if [[ -f "$VPS_CONF" ]] && grep -q "==== SHOWON AUTOCONFIG BEGIN ====" "$VPS_CONF"; then
    echo -e "${CYAN}[INFO]${NC} Removing ShowOn Nginx block from $VPS_CONF"
    awk '
      /==== SHOWON AUTOCONFIG BEGIN ====/ {skip=1}
      /==== SHOWON AUTOCONFIG END ====/   {skip=0; next}
      skip != 1 {print}
    ' "$VPS_CONF" > "${VPS_CONF}.tmp" && mv "${VPS_CONF}.tmp" "$VPS_CONF"
  fi

  if systemctl is-active --quiet nginx; then
    systemctl reload nginx 2>/dev/null || true
  fi

  # ask before purging nginx/conntrack to avoid breaking givpn
  read -rp "ต้องการถอนการติดตั้ง nginx และ conntrack ออกจากระบบด้วยหรือไม่? (y/N): " rmng
  if [[ "$rmng" =~ ^[Yy]$ ]]; then
    apt purge -y nginx conntrack >/dev/null 2>&1 || true
    apt autoremove -y >/dev/null 2>&1 || true
  fi

  # remove conntrack entries from sysctl.conf
  sed -i '/^net\.netfilter\.nf_conntrack_udp_timeout=/d' /etc/sysctl.conf
  sed -i '/^net\.netfilter\.nf_conntrack_udp_timeout_stream=/d' /etc/sysctl.conf

  sysctl -p >/dev/null 2>&1 || true

  echo -e "${GREEN}[SUCCESS]${NC} Uninstalled ShowOn (services + config cleaned)."
  press
}

# =====================================================
# อัปเดต
# =====================================================

update_script() {
  echo -e "${CYAN}[INFO]${NC} Updating all ShowOn components..."
  rotate_log

  # ensure WWW_DIR exists before writing index.html
  mkdir -p "$WWW_DIR"

  download_or_die "$SRC_ONLINE?$(date +%s)" "$SCRIPT_ONLINE"
  download_or_die "$SRC_VNSTAT?$(date +%s)" "$SCRIPT_VNSTAT"
  download_or_die "$SRC_V2RAY?$(date +%s)" "$SCRIPT_V2RAY"
  download_or_die "$SRC_SYSINFO?$(date +%s)" "$SCRIPT_SYSINFO"
  chmod +x "$SCRIPT_ONLINE" "$SCRIPT_VNSTAT" "$SCRIPT_V2RAY" "$SCRIPT_SYSINFO"

  download_or_die "$SRC_INDEX?$(date +%s)" "$WWW_DIR/index.html"
  chmod 644 "$WWW_DIR/index.html"

  local TMP_SCRIPT="/tmp/Install.$$"
  if curl -fsSL "$REPO_RAW/Install?$(date +%s)" -o "$TMP_SCRIPT"; then
    mv "$TMP_SCRIPT" /root/Install
    chmod +x /root/Install
    echo -e "${GREEN}[OK]${NC} Updated Install script (saved as /root/Install)."
  else
    echo -e "${RED}[ERROR]${NC} Failed to update Install script."
  fi

  # reload services safely
  systemctl daemon-reload
  systemctl restart online-check vnstat-traffic v2ray-traffic sysinfo 2>/dev/null || true

  # update local version file
  echo "$VERSION" > "$VERSION_FILE"

  echo -e "${GREEN}[OK]${NC} Update completed."
  press
}

# =====================================================
# Debug Log / Change Limit
# =====================================================

check_debug() {
  rotate_log
  if [[ -f "$DEBUG_LOG" ]]; then
    tail -n 100 "$DEBUG_LOG"
  else
    echo "No debug log yet."
  fi
  press
}

change_limit() {
  if [[ ! -f "$CONF_FILE" ]]; then
    echo -e "${RED}[ERROR]${NC} Config file not found!"
    press; return
  fi

  # shellcheck disable=SC1090
  source "$CONF_FILE"
  echo -e "${CYAN}[INFO]${NC} Current Limit User Online: ${LIMIT:-2000}"
  read -rp "Enter new Limit User Online: " NEW_LIMIT
  if [[ -z "$NEW_LIMIT" ]]; then
    echo -e "${YELLOW}[WARN]${NC} ไม่ได้เปลี่ยนค่า"
    press; return
  fi

  sed -i "s/^LIMIT=.*/LIMIT=${NEW_LIMIT}/" "$CONF_FILE"
  echo -e "${GREEN}[OK]${NC} คุณได้เปลี่ยน Limit User Online แล้วเป็น ${NEW_LIMIT} คน"
  press
}

# =====================================================
# Setup Swap (อัตโนมัติ + รีสตาร์ต service)
# =====================================================

setup_swap() {
  echo -e "${CYAN}[INFO]${NC} Auto Swap Wizard"

  # ขนาด RAM (MiB)
  local ram_kb=$(grep MemTotal /proc/meminfo | awk '{print $2}')
  local ram_mb=$(( ram_kb / 1024 ))

  # กำหนดสัดส่วน swap ตามช่วง RAM
  local swap_mb
  if   (( ram_mb <= 512 )); then       swap_mb=$(( ram_mb * 2 ))
  elif (( ram_mb <= 1024 )); then      swap_mb=$(( ram_mb * 2 ))
  elif (( ram_mb <= 2048 )); then      swap_mb=$(( ram_mb * 1 ))
  elif (( ram_mb <= 4096 )); then      swap_mb=$(( ram_mb * 1 ))
  elif (( ram_mb <= 8192 )); then      swap_mb=4096
  elif (( ram_mb <= 16384 )); then     swap_mb=4096
  elif (( ram_mb <= 32768 )); then     swap_mb=8192
  elif (( ram_mb <= 65536 )); then     swap_mb=8192
  else                                 swap_mb=8192
  fi

  # มี swap อยู่แล้วหรือไม่
  if swapon --show | awk 'NR>1{print $1}' | grep -q .; then
    echo -e "${YELLOW}[WARN]${NC} พบ Swap เดิมอยู่แล้ว"
    read -rp "ต้องการสร้างใหม่ทับเดิมหรือไม่? (Y/n): " ans
    if [[ -z "$ans" || "$ans" =~ ^[Yy]$ ]]; then
      swapoff -a || true
      sed -i '/swapfile showon/d' /etc/fstab || true
    else
      echo -e "${GREEN}[OK]${NC} ข้ามการสร้าง Swap ใหม่"
      press; return
    fi
  fi

  echo -e "${CYAN}[INFO]${NC} Creating swapfile size ${swap_mb} MiB ..."
  fallocate -l "${swap_mb}M" /swapfile || dd if=/dev/zero of=/swapfile bs=1M count="${swap_mb}"
  chmod 600 /swapfile
  mkswap /swapfile >/dev/null
  swapon /swapfile

  if ! grep -q "swapfile showon" /etc/fstab; then
    echo "/swapfile none swap sw 0 0 # swapfile showon" >> /etc/fstab
  fi

  sysctl -w vm.swappiness=10 >/dev/null
  sysctl -w vm.vfs_cache_pressure=100 >/dev/null
  if ! grep -q '^vm.swappiness' /etc/sysctl.conf; then echo "vm.swappiness=10" >> /etc/sysctl.conf; fi
  if ! grep -q '^vm.vfs_cache_pressure' /etc/sysctl.conf; then echo "vm.vfs_cache_pressure=100" >> /etc/sysctl.conf; fi

  echo -e "${GREEN}[OK]${NC} Swap พร้อมใช้งาน:"
  free -h

  systemctl restart online-check.service vnstat-traffic.service v2ray-traffic.service sysinfo.service 2>/dev/null || true
  echo -e "${GREEN}[OK]${NC} Restarted ShowOn services."
  press
}

# =====================================================
# เมนู
# =====================================================

show_menu() {
  clear
  print_status
  check_update
  echo "1) Install Script"
  echo "2) Uninstall Script"
  echo "3) Update Script"
  echo "4) Check Debug Log"
  echo "5) Change Limit User Online"
  echo "6) Setup Swap"
  echo "0) Exit"
  echo "==============================="
  read -rp "Choose an option [0-6]: " choice
  case "$choice" in
    1) install_script ;;
    2) uninstall_script ;;
    3) update_script ;;
    4) check_debug ;;
    5) change_limit ;;
    6) setup_swap ;;
    0) exit 0 ;;
    *) echo -e "${RED}[ERROR]${NC} Invalid choice"; sleep 1 ;;
  esac
  show_menu
}

# =====================================================
# Main
# =====================================================

require_root
show_menu
