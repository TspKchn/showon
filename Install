#!/bin/bash
# =====================================================
# ShowOn Script Manager V.1.0.7 (FULL VERSION)
# Author : TspKchn + ChatGPT
# Description : Universal Server Monitor Installer
# Compatible : Ubuntu 18.04+ / Debian 10+
# =====================================================

set -euo pipefail
trap 'echo "[ERROR] line $LINENO: exit status $?" >> /var/log/showon-debug.log' ERR

# ----------------- GLOBAL VARIABLES ------------------
VERSION="1.0.7"
REPO_RAW="https://raw.githubusercontent.com/TspKchn/showon/main"

BIN_DIR="/usr/local/bin"
WWW_DIR="/var/www/html/server"
CONF_FILE="/etc/showon.conf"
DEBUG_LOG="/var/log/showon-debug.log"

SYSTEMD_DIR="/etc/systemd/system"
NGINX_AV="/etc/nginx/sites-available/showon"
NGINX_EN="/etc/nginx/sites-enabled/showon"

SERVICE_ONLINE="$SYSTEMD_DIR/online-check.service"
SERVICE_VNSTAT="$SYSTEMD_DIR/vnstat-traffic.service"
SERVICE_V2RAY="$SYSTEMD_DIR/v2ray-traffic.service"
SERVICE_SYSINFO="$SYSTEMD_DIR/sysinfo.service"

# Scripts source
SRC_ONLINE="$REPO_RAW/scripts/online-check.sh"
SRC_VNSTAT="$REPO_RAW/scripts/vnstat-traffic.sh"
SRC_V2RAY="$REPO_RAW/scripts/v2ray-traffic.sh"
SRC_SYSINFO="$REPO_RAW/scripts/sysinfo.sh"
SRC_INDEX="$REPO_RAW/web/index.html"

# ----------------- COLORS ----------------------------
GREEN="\e[32m"
RED="\e[31m"
YELLOW="\e[33m"
CYAN="\e[36m"
BOLD="\e[1m"
NC="\e[0m"

# =====================================================
# BASIC FUNCTIONS
# =====================================================

require_root() {
  if [[ $EUID -ne 0 ]]; then
    echo -e "${RED}[ERROR]${NC} Please run as root."
    exit 1
  fi
}

press_enter() {
  read -rp "Press Enter to continue..." _
}

msg_ok() {
  echo -e "${GREEN}[OK]${NC} $*"
}

msg_info() {
  echo -e "${CYAN}[INFO]${NC} $*"
}

msg_warn() {
  echo -e "${YELLOW}[WARN]${NC} $*"
}

msg_err() {
  echo -e "${RED}[ERROR]${NC} $*"
}

rotate_log() {
  local max=1000000
  if [[ -f "$DEBUG_LOG" && $(stat -c%s "$DEBUG_LOG") -gt $max ]]; then
    mv "$DEBUG_LOG" "$DEBUG_LOG.1"
    : > "$DEBUG_LOG"
  fi
}

get_nic() {
  ip -o -4 route get 8.8.8.8 2>/dev/null | awk '{for(i=1;i<=NF;i++) if($i=="dev") print $(i+1)}' | head -n1
}

get_public_ip() {
  local ip
  for s in \
    "https://api.ipify.org" \
    "https://ifconfig.me" \
    "https://ipv4.icanhazip.com"; do
    ip=$(curl -fsSL "$s" 2>/dev/null | tr -d '\n\r')
    [[ -n "$ip" ]] && echo "$ip" && return 0
  done
  echo "127.0.0.1"
}

download_or_die() {
  local url="$1" dst="$2"
  if ! curl -fsSL "$url" -o "$dst"; then
    msg_err "Download failed: $url"
    exit 1
  fi
}

ensure_nginx() {
  if ! command -v nginx >/dev/null 2>&1; then
    msg_info "Installing nginx..."
    apt-get update -y >/dev/null 2>&1
    apt-get install -y nginx >/dev/null 2>&1
  fi
}

write_nginx() {
  local port=${1:-82}
  ensure_nginx
  mkdir -p "$WWW_DIR"
  mkdir -p /etc/nginx/sites-available /etc/nginx/sites-enabled

  [[ -f /etc/nginx/sites-enabled/default ]] && rm -f /etc/nginx/sites-enabled/default
  [[ -f /etc/nginx/sites-available/default ]] && rm -f /etc/nginx/sites-available/default

  cat >"$NGINX_AV" <<EOF
server {
    listen $port;
    server_name _;

    location = / {
        return 302 /server/;
    }

    location /server/ {
        alias $WWW_DIR/;
        index index.html;
        autoindex off;
        add_header Cache-Control "no-store";

        location ~ /server/online_app(\.json)?\$ {
            default_type application/json;
            add_header Content-Type application/json;
        }
    }
}
EOF

  ln -sf "$NGINX_AV" "$NGINX_EN"

  if nginx -t >/dev/null 2>&1; then
    systemctl restart nginx >/dev/null 2>&1 || true
    msg_ok "Nginx configured on port :$port"
  else
    msg_warn "nginx config test failed — forcing restart..."
    systemctl restart nginx >/dev/null 2>&1 || true
  fi
}

setup_environment() {
  require_root
  rotate_log
  mkdir -p "$BIN_DIR" "$WWW_DIR"
  touch "$DEBUG_LOG"
  chmod 644 "$DEBUG_LOG"
  msg_info "Environment prepared"
}
# =====================================================
# SCRIPT INSTALLERS
# =====================================================

install_scripts() {
  msg_info "Downloading all sub-scripts..."
  download_or_die "$SRC_ONLINE" "$BIN_DIR/online-check"
  download_or_die "$SRC_VNSTAT" "$BIN_DIR/vnstat-traffic"
  download_or_die "$SRC_V2RAY" "$BIN_DIR/v2ray-traffic"
  download_or_die "$SRC_SYSINFO" "$BIN_DIR/sysinfo"

  chmod +x "$BIN_DIR"/{online-check,vnstat-traffic,v2ray-traffic,sysinfo}
  msg_ok "All sub-scripts installed to $BIN_DIR"
}

# =====================================================
# CREATE SERVICES
# =====================================================

create_service_file() {
  local name="$1"
  local desc="$2"
  local exec="$3"
  local file="$SYSTEMD_DIR/${name}.service"

  cat >"$file" <<EOF
[Unit]
Description=$desc
After=network.target

[Service]
Type=simple
ExecStart=$exec
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
EOF

  systemctl daemon-reload >/dev/null 2>&1
  systemctl enable "$name" >/dev/null 2>&1 || true
  msg_ok "Service created: $name"
}

create_services() {
  msg_info "Creating systemd services..."
  create_service_file "online-check" "Online Status Monitor" "$BIN_DIR/online-check"
  create_service_file "vnstat-traffic" "VNStat Traffic Collector" "$BIN_DIR/vnstat-traffic"
  create_service_file "v2ray-traffic" "V2Ray Traffic Collector" "$BIN_DIR/v2ray-traffic"
  create_service_file "sysinfo" "System Info Updater" "$BIN_DIR/sysinfo"

  systemctl restart online-check vnstat-traffic v2ray-traffic sysinfo >/dev/null 2>&1 || true
}

# =====================================================
# SYSTEM STATUS REPORT
# =====================================================

print_status() {
  local ip port domain
  port=${1:-82}
  domain=$(hostname -f 2>/dev/null || echo "localhost")
  ip=$(get_public_ip)
  local json_url="http://$ip:$port/server/online_app.json"

  echo
  echo -e "${CYAN}=============================================${NC}"
  echo -e "${BOLD} ShowOn Server Installed Successfully!${NC}"
  echo -e "${CYAN}=============================================${NC}"
  echo
  echo -e "${GREEN}Monitor URL:${NC}   $json_url"
  echo -e "${GREEN}Hostname:${NC}      $domain"
  echo -e "${GREEN}Version:${NC}       $VERSION"
  echo
}

# =====================================================
# CHECK FOR UPDATES
# =====================================================

check_update() {
  local remote localv
  localv="$VERSION"
  remote=$(curl -fsSL "$REPO_RAW/VERSION" 2>/dev/null || echo "$VERSION")
  if [[ "$remote" != "$localv" ]]; then
    msg_warn "A newer version ($remote) is available."
  else
    msg_ok "You are running the latest version ($localv)"
  fi
}

# =====================================================
# SCRIPT TO JSON BUILDER
# =====================================================

generate_json() {
  local ip port nic uptime load users mem cpu
  ip=$(get_public_ip)
  nic=$(get_nic)
  port=${1:-82}
  uptime=$(uptime -p | cut -d' ' -f2-)
  load=$(awk '{print $1","$2","$3}' /proc/loadavg)
  users=$(who | wc -l)
  mem=$(free -m | awk '/Mem:/ {print $3"/"$2"MB"}')
  cpu=$(top -bn1 | awk '/Cpu/ {print int(100-$8)"%"}')

  cat > "$WWW_DIR/online_app.json" <<EOF
{
  "version": "$VERSION",
  "public_ip": "$ip",
  "nic": "$nic",
  "uptime": "$uptime",
  "load": "$load",
  "users_online": "$users",
  "memory_usage": "$mem",
  "cpu_usage": "$cpu",
  "timestamp": "$(date '+%Y-%m-%d %H:%M:%S')"
}
EOF
}

# =====================================================
# SELF-UPDATE LOGIC
# =====================================================

update_script() {
  local url="$REPO_RAW/install.sh"
  msg_info "Updating ShowOn Installer..."
  download_or_die "$url" "/tmp/showon-install.sh"
  chmod +x /tmp/showon-install.sh
  mv /tmp/showon-install.sh "$0"
  msg_ok "Script updated successfully."
}

# =====================================================
# DROPBEAR / GIVPN ONLINE CHECK INTEGRATION
# =====================================================

integrate_dropbear_givpn() {
  msg_info "Integrating Dropbear online status with givpn..."
  local givpn_json="$WWW_DIR/online_app.json"
  local tmpfile="/tmp/givpn_users.tmp"

  cat > "$BIN_DIR/dropbear-givpn-check" <<'EOF'
#!/bin/bash
set -e
OUT="/tmp/givpn_users.tmp"
DROPBEAR_LOG="/var/log/auth.log"
ONLINE_JSON="/var/www/html/server/online_app.json"

users=$(grep -i "Password auth succeeded" "$DROPBEAR_LOG" | awk '{print $9}' | sort -u | xargs)
online_count=$(echo "$users" | wc -w)
timestamp=$(date '+%Y-%m-%d %H:%M:%S')

jq ".dropbear_online = $online_count | .dropbear_users = \"$users\" | .last_dropbear_check = \"$timestamp\"" "$ONLINE_JSON" > "$OUT" && mv "$OUT" "$ONLINE_JSON"
EOF

  chmod +x "$BIN_DIR/dropbear-givpn-check"

  cat > "$SYSTEMD_DIR/dropbear-givpn.service" <<EOF
[Unit]
Description=Dropbear + GiVPN Online Updater
After=network.target dropbear.service

[Service]
Type=simple
ExecStart=$BIN_DIR/dropbear-givpn-check
Restart=always
RestartSec=30

[Install]
WantedBy=multi-user.target
EOF

  systemctl daemon-reload >/dev/null 2>&1
  systemctl enable dropbear-givpn.service >/dev/null 2>&1
  systemctl restart dropbear-givpn.service >/dev/null 2>&1 || true

  msg_ok "Dropbear integration completed."
}

# =====================================================
# MAIN INSTALL FUNCTION
# =====================================================

main_install() {
  require_root
  setup_environment

  msg_info "Installing dependencies..."
  apt-get update -y >/dev/null 2>&1
  apt-get install -y curl jq vnstat nginx dropbear >/dev/null 2>&1 || true

  msg_info "Downloading web index..."
  download_or_die "$SRC_INDEX" "$WWW_DIR/index.html"

  install_scripts
  create_services
  integrate_dropbear_givpn
  write_nginx 82
  generate_json 82

  print_status 82
}
# =====================================================
# UNINSTALL FUNCTION
# =====================================================

uninstall_script() {
  echo -e "${RED}Are you sure you want to uninstall ShowOn? (y/N):${NC}"
  read -r confirm
  if [[ "$confirm" =~ ^[Yy]$ ]]; then
    msg_info "Stopping services..."
    systemctl stop online-check vnstat-traffic v2ray-traffic sysinfo dropbear-givpn 2>/dev/null || true
    systemctl disable online-check vnstat-traffic v2ray-traffic sysinfo dropbear-givpn 2>/dev/null || true

    msg_info "Removing files..."
    rm -f "$BIN_DIR"/{online-check,vnstat-traffic,v2ray-traffic,sysinfo,dropbear-givpn-check}
    rm -f "$SYSTEMD_DIR"/{online-check.service,vnstat-traffic.service,v2ray-traffic.service,sysinfo.service,dropbear-givpn.service}
    rm -f "$WWW_DIR"/{index.html,online_app.json}
    rm -f /usr/local/bin/showon
    systemctl daemon-reload >/dev/null 2>&1

    msg_ok "ShowOn completely uninstalled."
  else
    msg_warn "Uninstallation aborted."
  fi
}

# =====================================================
# DEBUG LOG FUNCTION
# =====================================================

check_debug_log() {
  echo
  echo -e "${BOLD}===== DEBUG LOG =====${NC}"
  echo
  echo "[INFO] Services status:"
  systemctl status online-check vnstat-traffic v2ray-traffic sysinfo dropbear-givpn --no-pager | grep -E "Active:|Loaded:" || true
  echo
  echo "[INFO] JSON File:"
  ls -lh "$WWW_DIR"/online_app.json 2>/dev/null || echo "JSON not found!"
  echo
  echo "[INFO] Public IP:"
  get_public_ip
  echo
  echo -e "${CYAN}============================${NC}"
}

# =====================================================
# CHANGE LIMIT USER ONLINE
# =====================================================

change_limit_user() {
  local limit_file="/etc/showon_limit.conf"
  local limit

  echo -e "${BOLD}Current limit:$( [[ -f $limit_file ]] && cat "$limit_file" || echo 'Not set' )${NC}"
  echo -ne "${YELLOW}Enter new user limit:${NC} "
  read -r limit

  if [[ "$limit" =~ ^[0-9]+$ ]]; then
    echo "$limit" >"$limit_file"
    msg_ok "Limit updated to $limit users."
  else
    msg_error "Invalid number!"
  fi
}

# =====================================================
# SETUP SWAP MEMORY
# =====================================================

setup_swap() {
  local swapfile="/swapfile"
  echo -e "${BOLD}Enter swap size in MB (e.g., 1024 for 1GB):${NC}"
  read -r size

  if [[ "$size" =~ ^[0-9]+$ ]]; then
    msg_info "Creating $size MB swap..."
    fallocate -l "${size}M" "$swapfile"
    chmod 600 "$swapfile"
    mkswap "$swapfile" >/dev/null
    swapon "$swapfile"
    echo "$swapfile none swap sw 0 0" >> /etc/fstab
    msg_ok "Swap created and enabled."
  else
    msg_error "Invalid size!"
  fi
}

# =====================================================
# MAIN MENU
# =====================================================

show_menu() {
  clear
  echo -e "${BOLD}${CYAN}========================================${NC}"
  echo -e "${BOLD}        SHOWON CONTROL PANEL v$VERSION  ${NC}"
  echo -e "${BOLD}${CYAN}========================================${NC}"
  echo
  echo "1) Install Script"
  echo "2) Uninstall Script"
  echo "3) Update Script"
  echo "4) Check Debug Log"
  echo "5) Change Limit User Online"
  echo "6) Setup Swap"
  echo "0) Exit"
  echo "==============================="
  echo -ne "${YELLOW}Choose an option [0-6]: ${NC}"
  read -r option
  echo

  case "$option" in
  1)
    main_install
    ;;
  2)
    uninstall_script
    ;;
  3)
    update_script
    ;;
  4)
    check_debug_log
    ;;
  5)
    change_limit_user
    ;;
  6)
    setup_swap
    ;;
  0)
    echo -e "${GREEN}Exiting...${NC}"
    exit 0
    ;;
  *)
    msg_error "Invalid option!"
    ;;
  esac

  echo
  echo -e "${CYAN}Press Enter to continue...${NC}"
  read -r
  show_menu
}

# =====================================================
# MAIN EXECUTION
# =====================================================

if [[ "${BASH_SOURCE[0]}" == "$0" ]]; then
  show_menu
fi
# =====================================================
# UTILITY FUNCTIONS (Public IP / Logging / Network)
# =====================================================

get_public_ip() {
  local ip=""
  # พยายามเช็คจาก 3 เว็บ
  for site in \
    "https://api.ipify.org" \
    "https://ipinfo.io/ip" \
    "https://ifconfig.me"; do
    ip=$(curl -4s "$site" | grep -Eo '([0-9]{1,3}\.){3}[0-9]{1,3}' | head -n1)
    [[ -n "$ip" ]] && break
  done

  if [[ -z "$ip" ]]; then
    msg_warn "Cannot detect external IP automatically."
    echo -ne "${YELLOW}Enter server IP manually:${NC} "
    read -r ip
  fi
  echo "$ip"
}

print_log_header() {
  echo "===== ShowOn Install Log $(date '+%F %T') =====" >>"$DEBUG_LOG"
}

print_log_header

# =====================================================
# CHECK & CONFIGURE NGINX
# =====================================================

configure_nginx() {
  if ! command -v nginx >/dev/null 2>&1; then
    msg_info "Installing Nginx..."
    apt-get install -y nginx >/dev/null 2>&1
    msg_ok "Nginx installed."
  fi

  mkdir -p "$WWW_DIR"
  chown -R www-data:www-data "$WWW_DIR"

  cat >/etc/nginx/sites-available/showon.conf <<EOF
server {
    listen 80 default_server;
    listen [::]:80 default_server;
    root $WWW_DIR;
    index index.html online_app.json online_app;
    server_name _;
    location / {
        try_files \$uri \$uri/ =404;
    }
}
EOF

  ln -sf /etc/nginx/sites-available/showon.conf /etc/nginx/sites-enabled/showon.conf
  rm -f /etc/nginx/sites-enabled/default
  nginx -t >/dev/null 2>&1 && systemctl restart nginx && msg_ok "Nginx configured successfully."
}

# =====================================================
# FINAL INSTALL SUMMARY
# =====================================================

final_summary() {
  local ip
  ip=$(get_public_ip)
  echo
  echo -e "${BOLD}${GREEN}=================================================${NC}"
  echo -e "${BOLD}✅ INSTALLATION COMPLETE${NC}"
  echo -e "${CYAN}Version:${NC} $VERSION"
  echo -e "${CYAN}Web Panel:${NC} http://$ip/server/"
  echo -e "${CYAN}JSON File:${NC} $WWW_DIR/online_app.json"
  echo -e "${CYAN}Command:${NC} showon"
  echo -e "${BOLD}${GREEN}=================================================${NC}"
}

# =====================================================
# SCRIPT ENTRY POINT
# =====================================================

if [[ "${BASH_SOURCE[0]}" == "$0" ]]; then
  clear
  echo -e "${BOLD}${CYAN}========================================${NC}"
  echo -e "${BOLD}      SHOWON INSTALLER v$VERSION${NC}"
  echo -e "${BOLD}${CYAN}========================================${NC}"
  echo
  show_menu
fi
