#!/bin/bash
VERSION="V.1.0.0"
INSTALL_LOG="/var/log/showon-install.log"
SERVICE_FILE="/etc/systemd/system/online-check.service"
NGINX_SITE="/etc/nginx/sites-available/showon"

clear
echo "===================================="
echo "     Menu Script Show Online User"
echo " Installed : $VERSION"
echo " Last Update: $(date '+%Y-%m-%d %H:%M:%S')"
echo "------------------------------------"

# Detect IP
IP=$(hostname -I | awk '{print $1}')
PANEL_PORT=88
PANEL_URL="http://$IP:$PANEL_PORT"
SHOWON_URL="http://$IP:82/server/"

echo " 3X-UI Panel URL : $PANEL_URL"
echo " Show Online URL : $SHOWON_URL"
echo "===================================="

# -----------------------------
# INSTALL FUNCTION
# -----------------------------
install_script() {
    echo "[INFO] Updating system..."
    apt update -y >> $INSTALL_LOG 2>&1
    apt upgrade -y >> $INSTALL_LOG 2>&1
    apt install -y curl jq net-tools sqlite3 nginx bc >> $INSTALL_LOG 2>&1

    echo "[INFO] Cleaning old Nginx configs..."
    rm -f /etc/nginx/sites-enabled/showon
    rm -f /etc/nginx/sites-available/showon
    grep -rl "listen 82" /etc/nginx/sites-enabled/ | xargs -r rm -f
    grep -rl "listen 82" /etc/nginx/sites-available/ | xargs -r rm -f

    echo "[INFO] Setting up Nginx..."
    cat > $NGINX_SITE <<EOF
server {
    listen 82;
    listen [::]:82;
    root /var/www/html;
    index index.html;
    server_name _;
    location /server/ {
        autoindex on;
        default_type application/json;
    }
}
EOF
    ln -s $NGINX_SITE /etc/nginx/sites-enabled/showon 2>/dev/null

    if nginx -t; then
        systemctl restart nginx
        echo "[SUCCESS] Nginx configured."
    else
        echo "[ERROR] Invalid Nginx config. Exiting."
        exit 1
    fi

    echo "[INFO] Asking for 3X-UI credentials..."
    read -p "à¸à¸£à¸­à¸ X-UI panel username: " PANEL_USER
    read -s -p "à¸à¸£à¸­à¸ X-UI panel password: " PANEL_PASS
    echo ""

    echo "[INFO] Setting up online-check service..."
    cat > $SERVICE_FILE <<EOF
[Unit]
Description=Online Users Checker (SSH/V2Ray)
After=network.target

[Service]
ExecStart=/usr/local/bin/online-check.sh
Restart=always

[Install]
WantedBy=multi-user.target
EOF

    # ðŸ”¥ à¸•à¸±à¸§à¹€à¸Šà¹‡à¸„à¸ˆà¸£à¸´à¸‡
    cat > /usr/local/bin/online-check.sh <<EOF
#!/bin/bash
PANEL_URL="$PANEL_URL"
USERNAME="$PANEL_USER"
PASSWORD="$PANEL_PASS"
OUT_FILE="/var/www/html/server/online_app.json"

while true; do
    COOKIE=\$(curl -sk -X POST "\$PANEL_URL/login" \\
        -H "Content-Type: application/json" \\
        -d "{\"username\":\"\$USERNAME\",\"password\":\"\$PASSWORD\"}" \\
        -c - | grep 3x-ui | awk '{print \$7}')

    if [ -n "\$COOKIE" ]; then
        V2RAY_ONLINE=\$(curl -sk -b "3x-ui=\$COOKIE" "\$PANEL_URL/panel/inbound/onlines" | jq '.obj | length' 2>/dev/null)
    else
        V2RAY_ONLINE=0
    fi

    # TODO: à¹€à¸žà¸´à¹ˆà¸¡ logic à¸™à¸±à¸š SSH user à¸—à¸µà¹ˆà¸­à¸­à¸™à¹„à¸¥à¸™à¹Œà¸–à¹‰à¸²à¸„à¸¸à¸“à¸­à¸¢à¸²à¸à¹„à¸”à¹‰
    SSH_ONLINE=0

    echo "{\\"ssh\\":\$SSH_ONLINE,\\"v2ray\\":\$V2RAY_ONLINE}" > \$OUT_FILE
    sleep 5
done
EOF

    chmod +x /usr/local/bin/online-check.sh
    systemctl daemon-reexec
    systemctl enable online-check.service
    systemctl restart online-check.service

    echo "[SUCCESS] Install complete!"
    read -p "Press Enter to continue..."
}

# -----------------------------
# RESTART SERVICES
# -----------------------------
restart_all() {
    systemctl restart nginx
    systemctl restart online-check.service
    echo "[SUCCESS] All services restarted!"
    read -p "Press Enter to continue..."
}

# -----------------------------
# UNINSTALL
# -----------------------------
uninstall_script() {
    systemctl stop online-check.service
    systemctl disable online-check.service
    rm -f $SERVICE_FILE
    rm -f /usr/local/bin/online-check.sh
    rm -f $NGINX_SITE
    rm -f /etc/nginx/sites-enabled/showon
    systemctl restart nginx
    echo "[SUCCESS] Uninstalled!"
    read -p "Press Enter to continue..."
}

# -----------------------------
# FIX NGINX
# -----------------------------
fix_nginx() {
    echo "[INFO] Fixing Nginx..."
    rm -f $NGINX_SITE /etc/nginx/sites-enabled/showon
    grep -rl "listen 82" /etc/nginx/sites-enabled/ | xargs -r rm -f
    grep -rl "listen 82" /etc/nginx/sites-available/ | xargs -r rm -f
    systemctl restart nginx
    echo "[SUCCESS] Nginx fixed!"
    read -p "Press Enter to continue..."
}

# -----------------------------
# MENU LOOP
# -----------------------------
while true; do
    clear
    echo "===================================="
    echo "     Menu Script Show Online User"
    echo " Installed : $VERSION"
    echo " Last Update: $(date '+%Y-%m-%d %H:%M:%S')"
    echo "------------------------------------"
    echo " 3X-UI Panel URL : $PANEL_URL"
    echo " Show Online URL : $SHOWON_URL"
    echo "===================================="
    echo "1). Install Script"
    echo "2). Restart All Service"
    echo "3). Uninstall"
    echo "4). Update"
    echo "5). Fix Nginx"
    echo "0). Exit"
    echo "------------------------------------"
    read -p "Select option: " choice
    case $choice in
        1) install_script ;;
        2) restart_all ;;
        3) uninstall_script ;;
        4) exec bash <(curl -fsSL https://raw.githubusercontent.com/TspKchn/showon/refs/heads/main/Install) ;;
        5) fix_nginx ;;
        0) exit 0 ;;
        *) echo "Invalid choice." && sleep 2 ;;
    esac
done
