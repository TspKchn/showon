#!/bin/bash
# =====================================================
# ShowOn Script Installer V.1.0.3 (Stable)
# Author: TspKchn
# =====================================================

VERSION="V.1.0.3"
REPO_URL="https://raw.githubusercontent.com/TspKchn/showon/refs/heads/main/Install"

# ==========================
# Colors
# ==========================
GREEN="\e[32m"
RED="\e[31m"
YELLOW="\e[33m"
CYAN="\e[36m"
NC="\e[0m"

SHOWON_CMD="/usr/local/bin/showon"
WWW_DIR="/var/www/html/server"
SCRIPT_ONLINE="/usr/local/bin/online-check.sh"
SCRIPT_SYSINFO="/usr/local/bin/sysinfo.sh"
SERVICE_ONLINE="/etc/systemd/system/online-check.service"
SERVICE_SYSINFO="/etc/systemd/system/sysinfo.service"
CONF_FILE="/etc/showon.conf"
DEBUG_LOG="/var/log/showon-debug.log"

# ==========================
# Menu Function
# ==========================
show_menu() {
    clear
    echo -e "==============================="
    echo -e "   ShowOn Script Manager ${VERSION}"
    echo -e "==============================="

    echo "1) Install Script"
    echo "2) Update Script"
    echo "3) Check Debug Log"
    echo "0) Exit"
    echo "==============================="
    read -p "Choose an option [0,1,2,3]: " choice

    case $choice in
        1) install_script ;;
        2) update_script ;;
        3) check_debug ;;
        0) exit 0 ;;
        *) echo -e "${RED}[ERROR] Invalid choice...${NC}" ; sleep 2 ; show_menu ;;
    esac
}

# ==========================
# Update Script
# ==========================
update_script() {
    echo -e "${CYAN}[INFO]${NC} Checking update..."
    LATEST_VERSION=$(curl -s "$REPO_URL" | grep -m1 "VERSION=" | cut -d'"' -f2)
    if [[ -n "$LATEST_VERSION" && "$LATEST_VERSION" != "$VERSION" ]]; then
        wget -q -O /root/Install "$REPO_URL"
        chmod +x /root/Install
        echo -e "${GREEN}[SUCCESS]${NC} Updated to ${LATEST_VERSION}"
        echo -e "${CYAN}[INFO]${NC} Please run 'showon' again."
    else
        echo -e "${GREEN}[INFO]${NC} Already latest version."
    fi
    read -p "Press Enter to return..." _
    show_menu
}

# ==========================
# Check Debug Log
# ==========================
check_debug() {
    echo -e "${CYAN}[INFO]${NC} Showing debug log (${DEBUG_LOG})"
    echo "-----------------------------------------"
    if [ -f "$DEBUG_LOG" ]; then
        tail -n 50 "$DEBUG_LOG"
    else
        echo "No debug log found."
    fi
    echo "-----------------------------------------"
    read -p "Press Enter to return..." _
    show_menu
}

# ==========================
# Install Script
# ==========================
install_script() {
    echo -e "${CYAN}[INFO]${NC} Installing ShowOn ${VERSION}..."

    apt update -y && apt install -y curl jq net-tools psmisc nginx iproute2 ca-certificates

    mkdir -p "$WWW_DIR"
    chmod -R 755 "$WWW_DIR"

    # Clean old debug log
    echo "" > "$DEBUG_LOG"

    # -----------------------------
    # Detect Mode + Ask Config
    # -----------------------------
    if [ -f /etc/x-ui/x-ui.db ]; then
        read -p "3X-UI URL (copy login URL): " PANEL_URL
        read -p "3X-UI Username: " USERNAME
        read -p "3X-UI Password: " PASSWORD

        cat >"$CONF_FILE" <<EOF
PANEL_URL="$PANEL_URL"
USERNAME="$USERNAME"
PASSWORD="$PASSWORD"
WWW_DIR="$WWW_DIR"
EOF
        chmod 600 "$CONF_FILE"
    elif [ -f /usr/local/etc/xray/config.json ] || [ -f /etc/xray/config.json ]; then
        cat >"$CONF_FILE" <<EOF
WWW_DIR="$WWW_DIR"
EOF
        chmod 600 "$CONF_FILE"
    else
        echo -e "${YELLOW}[WARN]${NC} ไม่พบทั้ง 3x-ui หรือ Xray-core config.json"
    fi

    # -----------------------------
    # Limit User Online
    # -----------------------------
    read -p "Limit User Online (default 2000): " LIMIT
    LIMIT=${LIMIT:-2000}
    echo "LIMIT=$LIMIT" >> "$CONF_FILE"

    # -----------------------------
    # online-check.sh
    # -----------------------------
    cat >"$SCRIPT_ONLINE" <<'EOF'
#!/bin/bash
set -e
source /etc/showon.conf
LIMIT=${LIMIT:-2000}
DEBUG_LOG="/var/log/showon-debug.log"

_ons=$(ss -nt state established | grep -E ':22 ' | wc -l)
_onop=0
[ -f /etc/openvpn/server/openvpn-status.log ] && \
  _onop=$(grep -c "CLIENT_LIST" /etc/openvpn/server/openvpn-status.log || true)
_ondrp=$(pgrep dropbear | wc -l)
_onv2=0

if [ -f /etc/x-ui/x-ui.db ]; then
    COOKIE=$(curl -sk -c - -X POST "$PANEL_URL/login" \
      -H "Content-Type: application/json" \
      -d "{\"username\":\"$USERNAME\",\"password\":\"$PASSWORD\"}" \
      | grep 3x-ui | awk '{print $7}' || true)
    if [ -n "$COOKIE" ]; then
        _onv2=$(curl -sk -b "3x-ui=$COOKIE" -X POST \
          "$PANEL_URL/panel/inbound/onlines" \
          -H "Content-Type: application/x-www-form-urlencoded" \
          | jq '.obj | length' 2>/dev/null || echo "0")
    fi
fi

JSON=$(jq -n \
  --arg onlines "$(( _ons + _onop + _ondrp + _onv2 ))" \
  --arg ssh "$_ons" \
  --arg openvpn "$_onop" \
  --arg dropbear "$_ondrp" \
  --arg v2ray "$_onv2" \
  --arg limite "$LIMIT" \
  '[{onlines:$onlines|tonumber, limite:$limite|tonumber, ssh:$ssh|tonumber, openvpn:$openvpn|tonumber, dropbear:$dropbear|tonumber, v2ray:$v2ray|tonumber}]')

echo "$JSON" > "$WWW_DIR/online_app.json"
echo "$(date) ONLINE_CHECK -> $JSON" >> "$DEBUG_LOG"
EOF
    chmod +x "$SCRIPT_ONLINE"

    # -----------------------------
    # sysinfo.sh
    # -----------------------------
    cat >"$SCRIPT_SYSINFO" <<'EOF'
#!/bin/bash
set -e
source /etc/showon.conf
DEBUG_LOG="/var/log/showon-debug.log"

uptime=$(uptime -p | sed 's/up //')
cpu_usage=$(top -bn1 | grep "Cpu(s)" | awk '{print 100 - $8"%"}')
mem_usage=$(free -m | awk 'NR==2{printf "%s / %s MB", $3,$2}')
disk_usage=$(df -h / | awk 'NR==2{print $3 " / " $2}')

JSON=$(jq -n \
  --arg uptime "$uptime" \
  --arg cpu_usage "$cpu_usage" \
  --arg ram_usage "$mem_usage" \
  --arg disk_usage "$disk_usage" \
  '{uptime:$uptime, cpu_usage:$cpu_usage, ram_usage:$ram_usage, disk_usage:$disk_usage}')

echo "$JSON" > "$WWW_DIR/sysinfo.json"
echo "$(date) SYSINFO -> $JSON" >> "$DEBUG_LOG"
EOF
    chmod +x "$SCRIPT_SYSINFO"

    # -----------------------------
    # Services
    # -----------------------------
    cat >"$SERVICE_ONLINE" <<EOF
[Unit]
Description=Online Users JSON Generator
After=network.target

[Service]
ExecStart=/bin/bash -c 'while true; do $SCRIPT_ONLINE; sleep 5; done'
Restart=always
RestartSec=5
EOF

    cat >"$SERVICE_SYSINFO" <<EOF
[Unit]
Description=System Info JSON Generator
After=network.target

[Service]
ExecStart=/bin/bash -c 'while true; do $SCRIPT_SYSINFO; sleep 5; done'
Restart=always
RestartSec=5
EOF

    systemctl daemon-reexec
    systemctl enable --now online-check.service sysinfo.service

    # -----------------------------
    # Nginx config
    # -----------------------------
    rm -f /etc/nginx/sites-available/server_checker /etc/nginx/sites-enabled/server_checker

    cat >/etc/nginx/sites-available/server_checker <<'EOF'
server {
    listen 82 default_server;
    server_name _;

    location = / {
        return 302 /server/;
    }

    location /server/ {
        alias /var/www/html/server/;
        index index.html;
    }
}
EOF

    ln -sf /etc/nginx/sites-available/server_checker /etc/nginx/sites-enabled/server_checker
    nginx -t && systemctl reload nginx

    echo -e "${GREEN}[SUCCESS]${NC} Installed ShowOn ${VERSION}"
    echo -e "${CYAN}[INFO]${NC} Open: http://$(hostname -I | awk '{print $1}'):82/server/"
    read -p "Press Enter to return to menu..." _
    show_menu
}

# ==========================
# Uninstall Script
# ==========================
uninstall_script() {
    echo -e "${YELLOW}[INFO]${NC} Uninstalling ShowOn Script..."

    systemctl stop online-check.service sysinfo.service 2>/dev/null
    systemctl disable online-check.service sysinfo.service 2>/dev/null

    rm -f "$SERVICE_ONLINE" "$SERVICE_SYSINFO"
    rm -f "$SCRIPT_ONLINE" "$SCRIPT_SYSINFO"
    rm -f "$CONF_FILE"
    rm -rf "$WWW_DIR"
    rm -f /etc/nginx/sites-available/server_checker /etc/nginx/sites-enabled/server_checker

    systemctl daemon-reload
    systemctl restart nginx

    echo -e "${GREEN}[SUCCESS]${NC} Uninstalled completely (no reboot needed)."
    read -p "Press Enter to return..." _
    show_menu
}

# ==========================
# Create showon command (always refresh)
# ==========================
rm -f /usr/bin/showon /bin/showon /usr/local/bin/showon

cat >"$SHOWON_CMD" <<'EOF'
#!/bin/bash
bash /root/Install
EOF
chmod +x "$SHOWON_CMD"

# ==========================
# Start Menu
# ==========================
show_menu
