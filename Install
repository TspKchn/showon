#!/bin/bash
# =====================================================
# ShowOn Script Installer V.1.0.6
# Author: TspKchn + ChatGPT
# =====================================================

VERSION="V.1.0.6"

# ===== GitHub Repo Path =====
REPO_RAW="https://raw.githubusercontent.com/TspKchn/showon/refs/heads/main"

# ===== Paths =====
BIN_DIR="/usr/local/bin"
CONF_FILE="/etc/showon.conf"
DEBUG_LOG="/var/log/showon-debug.log"
WWW_DIR="/var/www/html/server"

SCRIPT_ONLINE="$BIN_DIR/online-check.sh"
SCRIPT_VNSTAT="$BIN_DIR/vnstat-traffic.sh"
SCRIPT_V2RAY="$BIN_DIR/v2ray-traffic.sh"
SCRIPT_SYSINFO="$BIN_DIR/sysinfo.sh"
MENU_SCRIPT="$BIN_DIR/menu.sh"
UNINSTALL_SCRIPT="$BIN_DIR/uninstall.sh"

SERVICE_ONLINE="/etc/systemd/system/online-check.service"
SERVICE_VNSTAT="/etc/systemd/system/vnstat-traffic.service"
SERVICE_V2RAY="/etc/systemd/system/v2ray-traffic.service"
SERVICE_SYSINFO="/etc/systemd/system/sysinfo.service"

SITE_AV="/etc/nginx/sites-available/showon"
SITE_EN="/etc/nginx/sites-enabled/showon"

# ===== Colors =====
GREEN="\e[32m"; RED="\e[31m"; YELLOW="\e[33m"; CYAN="\e[36m"; NC="\e[0m"

require_root() {
  if [[ $EUID -ne 0 ]]; then
    echo -e "${RED}[ERROR]${NC} Please run as root."
    exit 1
  fi
}

header() {
  clear
  echo "==============================="
  echo "   ShowOn Script Installer ${VERSION}"
  echo "==============================="
}

download_or_die() {
  local url="$1" dst="$2"
  if ! curl -fsSL "$url" -o "$dst"; then
    echo -e "${RED}[ERROR]${NC} Download failed: $url"
    exit 1
  fi
  chmod +x "$dst"
}

install_script() {
  echo -e "${CYAN}[INFO]${NC} Installing ShowOn (${VERSION})..."
  apt update -y >/dev/null 2>&1 || true
  apt install -y curl jq net-tools psmisc nginx iproute2 ca-certificates >/dev/null 2>&1 || true

  mkdir -p "$BIN_DIR" "$WWW_DIR" "$(dirname "$DEBUG_LOG")"

  # ==== ดาวน์โหลดสคริปต์ทั้งหมด ====
  download_or_die "$REPO_RAW/scripts/online-check.sh" "$SCRIPT_ONLINE"
  download_or_die "$REPO_RAW/scripts/vnstat-traffic.sh" "$SCRIPT_VNSTAT"
  download_or_die "$REPO_RAW/scripts/v2ray-traffic.sh" "$SCRIPT_V2RAY"
  download_or_die "$REPO_RAW/scripts/sysinfo.sh" "$SCRIPT_SYSINFO"

  # ==== ดาวน์โหลด menu.sh และ uninstall.sh ====
  download_or_die "$REPO_RAW/menu.sh" "$MENU_SCRIPT"
  download_or_die "$REPO_RAW/uninstall.sh" "$UNINSTALL_SCRIPT"

  # ==== สร้าง index.html ====
  download_or_die "$REPO_RAW/web/index.html" "$WWW_DIR/index.html"
  chmod 644 "$WWW_DIR/index.html"

  # ==== nginx site ====
  cat >"$SITE_AV" <<EOF
server {
    listen 82 default_server;
    server_name _;

    location = / {
        return 302 /server/;
    }
    location /server/ {
        alias $WWW_DIR/;
        index index.html;
        autoindex off;
        add_header Cache-Control "no-store";
    }
}
EOF
  ln -sf "$SITE_AV" "$SITE_EN"
  systemctl restart nginx 2>/dev/null || true

  echo -e "${GREEN}[OK]${NC} Installed ShowOn ${VERSION}"
  echo -e "${CYAN}[INFO]${NC} Run with: menu.sh"
}

require_root
header
install_script
