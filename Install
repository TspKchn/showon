#!/bin/bash
# =====================================================
# ShowOn Script Manager V.1.0.7 (Fixed + Extended)
# Author : TspKchn + ChatGPT
# =====================================================

# ----------------- ‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô -----------------
VERSION="V.1.0.7"

# ----------------- ‡∏û‡∏≤‡∏ò‡∏£‡∏µ‡πÇ‡∏õ ------------------
REPO_RAW="https://raw.githubusercontent.com/TspKchn/showon/main"

# ----------------- ‡∏ã‡∏≠‡∏£‡πå‡∏™‡πÑ‡∏ü‡∏•‡πå ----------------
SRC_ONLINE="$REPO_RAW/scripts/online-check.sh"
SRC_VNSTAT="$REPO_RAW/scripts/vnstat-traffic.sh"
SRC_V2RAY="$REPO_RAW/scripts/v2ray-traffic.sh"
SRC_SYSINFO="$REPO_RAW/scripts/sysinfo.sh"
SRC_INDEX="$REPO_RAW/web/index.html"

# ----------------- ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á ----------
WWW_DIR="/var/www/html/server"
BIN_DIR="/usr/local/bin"
CONF_FILE="/etc/showon.conf"
DEBUG_LOG="/var/log/showon-debug.log"

SCRIPT_ONLINE="$BIN_DIR/online-check.sh"
SCRIPT_VNSTAT="$BIN_DIR/vnstat-traffic.sh"
SCRIPT_V2RAY="$BIN_DIR/v2ray-traffic.sh"
SCRIPT_SYSINFO="$BIN_DIR/sysinfo.sh"

SERVICE_ONLINE="/etc/systemd/system/online-check.service"
SERVICE_VNSTAT="/etc/systemd/system/vnstat-traffic.service"
SERVICE_V2RAY="/etc/systemd/system/v2ray-traffic.service"
SERVICE_SYSINFO="/etc/systemd/system/sysinfo.service"

SITE_AV="/etc/nginx/sites-available/showon"
SITE_EN="/etc/nginx/sites-enabled/showon"

# ----------------- ‡∏™‡∏µ ------------------------
GREEN="\e[32m"; RED="\e[31m"; YELLOW="\e[33m"; CYAN="\e[36m"; B="\e[1m"; NC="\e[0m"

# =====================================================
# ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô
# =====================================================

require_root() {
  if [[ $EUID -ne 0 ]]; then
    echo -e "${RED}[ERROR]${NC} Please run as root."
    exit 1
  fi
}

press() { read -rp "Press Enter to continue..." _; }

get_nic() {
  ip -o -4 route get 8.8.8.8 2>/dev/null \
    | awk '{for(i=1;i<=NF;i++) if($i=="dev") print $(i+1)}' \
    | head -n1
}

rotate_log() {
  local max=1000000
  if [[ -f "$DEBUG_LOG" && $(stat -c%s "$DEBUG_LOG") -gt $max ]]; then
    mv "$DEBUG_LOG" "$DEBUG_LOG.1"
    : > "$DEBUG_LOG"
  fi
}

download_or_die() {
  local url="$1" dst="$2"
  if ! curl -fsSL "$url" -o "$dst"; then
    echo -e "${RED}[ERROR]${NC} Download failed: $url"
    exit 1
  fi
}

write_nginx() {
  local port=${1:-82}
  mkdir -p "$WWW_DIR"
  mkdir -p /etc/nginx/sites-available /etc/nginx/sites-enabled

  [[ -f /etc/nginx/sites-enabled/default ]] && rm -f /etc/nginx/sites-enabled/default
  [[ -f /etc/nginx/sites-available/default ]] && rm -f /etc/nginx/sites-available/default

  cat >"$SITE_AV" <<EOF
server {
    listen $port;
    server_name _;

    location = / {
        return 302 /server/;
    }

    location /server/ {
        alias $WWW_DIR/;
        index index.html;
        autoindex off;
        add_header Cache-Control "no-store";

        # ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö MIME ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö online_app (‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•) ‡πÅ‡∏•‡∏∞ online_app.json
        location ~ /server/online_app(\.json)?$ {
            default_type application/json;
            add_header Content-Type application/json;
        }
    }
}
EOF

  ln -sf "$SITE_AV" "$SITE_EN"

  if nginx -t; then
    systemctl restart nginx 2>/dev/null || true
  else
    echo -e "${YELLOW}[WARN]${NC} nginx config test failed, forcing restart..."
    systemctl restart nginx 2>/dev/null || true
  fi

  echo -e "${GREEN}[OK]${NC} Nginx listening on port :$port (/server/)"
}

conntrack_status() {
  if command -v conntrack >/dev/null 2>&1; then echo "ON"; else echo "OFF"; fi
}

get_public_ip() {
  local ip
  for url in "https://ipinfo.io/ip" "https://ifconfig.me" "https://icanhazip.com"; do
    ip=$(curl -fsSL "$url" 2>/dev/null | tr -d '[:space:]')
    if [[ -n "$ip" && "$ip" =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
      echo "$ip"
      return
    fi
  done
  read -rp "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Public IP ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å IP ‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á: " ip
  echo "$ip"
}

# =======================
# Part 1/4 ‡∏à‡∏ö‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
# =======================
# =====================================================
# Part 2/4 ‚Äî ‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á, Config, ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå
# =====================================================

install_script() {
  echo -e "${CYAN}[INFO]${NC} Installing ShowOn (${VERSION})..."

  # 1) Update system
  echo -e "${CYAN}[INFO]${NC} Updating system packages..."
  apt update -y >/dev/null 2>&1 || true

  # 2) Install dependencies (‡∏£‡∏ß‡∏° nginx)
  echo -e "${CYAN}[INFO]${NC} Installing dependencies..."
  apt install -y curl jq net-tools psmisc nginx iproute2 ca-certificates vnstat conntrack >/dev/null 2>&1 || true

  # ‡∏õ‡∏£‡∏±‡∏ö timeout ‡∏Ç‡∏≠‡∏á conntrack UDP
  echo -e "${CYAN}[INFO]${NC} Tuning conntrack UDP timeout ‚Üí 5s"
  sysctl -w net.netfilter.nf_conntrack_udp_timeout=5 >/dev/null 2>&1 || true
  sysctl -w net.netfilter.nf_conntrack_udp_timeout_stream=5 >/dev/null 2>&1 || true

  if ! grep -q "nf_conntrack_udp_timeout" /etc/sysctl.conf; then
    echo "net.netfilter.nf_conntrack_udp_timeout=5" >> /etc/sysctl.conf
    echo "net.netfilter.nf_conntrack_udp_timeout_stream=5" >> /etc/sysctl.conf
    sysctl -p >/dev/null 2>&1 || true
  fi

  # 3) Enable vnstat
  systemctl enable vnstat >/dev/null 2>&1 || true
  systemctl start vnstat >/dev/null 2>&1 || true

  mkdir -p "$WWW_DIR" "$BIN_DIR" "$(dirname "$DEBUG_LOG")"
  rotate_log

  # ======================= ‡∏ï‡∏£‡∏ß‡∏à AGN-UDP (Hysteria) =======================
  local AGN_PRESENT="0" AGN_PORT=""

  if [[ -f /etc/hysteria/config.json ]]; then
    AGN_PORT=$(jq -r '.listen // empty' /etc/hysteria/config.json 2>/dev/null \
      | sed -E 's/^\[::\]://; s/^[^:]*://; s/[^0-9].*$//')
    if [[ -n "$AGN_PORT" && "$AGN_PORT" =~ ^[0-9]+$ ]]; then
      AGN_PRESENT="1"
      echo -e "${GREEN}[OK]${NC} AGN-UDP (Hysteria) detected from config ‚Üí port: ${B}${AGN_PORT}${NC}"
    else
      echo -e "${YELLOW}[WARN]${NC} Found hysteria config but no valid port"
    fi
  fi

  # ‡∏ß‡∏¥‡∏ò‡∏µ fallback ‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏≤‡∏Å systemd / binary
  if [[ "$AGN_PRESENT" == "0" ]]; then
    detect_agnudp() {
      local present="0" port=""
      if systemctl list-units --type=service | grep -q 'hysteria'; then
        port=$(ss -tulnp | grep hysteria | awk '{print $5}' | cut -d: -f2 | head -n1)
        [[ -n "$port" ]] && present="1"
      fi
      if [[ "$present" == "0" && -x "$(command -v hysteria)" ]]; then
        port=$(ss -tulnp | grep hysteria | awk '{print $5}' | cut -d: -f2 | head -n1)
        [[ -n "$port" ]] && present="1"
      fi
      echo "$present|$port"
    }
    IFS='|' read -r AGN_PRESENT AGN_PORT <<<"$(detect_agnudp)"
    if [[ "$AGN_PRESENT" == "1" ]]; then
      echo -e "${GREEN}[OK]${NC} AGN-UDP (Hysteria) detected via systemd/binary ‚Üí port: ${B}${AGN_PORT}${NC}"
    else
      echo -e "${CYAN}[INFO]${NC} AGN-UDP (Hysteria) not found ‚Üí skipped"
    fi
  fi

  # ======================= ‡∏ï‡∏£‡∏ß‡∏à 3x-ui ‡∏´‡∏£‡∏∑‡∏≠ Xray-Core =======================
  local PANEL_URL XUI_USER XUI_PASS
  if [[ -d /etc/x-ui ]]; then
    echo -e "${CYAN}[INFO]${NC} ‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö 3x-ui ‚Üí ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ API"
    echo "  üëâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤ '‡∏ß‡∏≤‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏´‡∏ô‡πâ‡∏≤‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏ó‡∏±‡πâ‡∏á‡πÄ‡∏™‡πâ‡∏ô' ‡πÄ‡∏ä‡πà‡∏ô:"
    echo "     https://IP:PORT/RandomPath"
    read -rp "3X-UI URL (copy login link): " PANEL_URL
    PANEL_URL="$(echo "$PANEL_URL" | sed 's:/*$::')"

    read -rp "3X-UI Username: " XUI_USER
    read -rp "3X-UI Password: " XUI_PASS
  else
    echo -e "${CYAN}[INFO]${NC} ‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö Xray-Core ‚Üí ‡∏Ç‡πâ‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ 3x-ui"
    PANEL_URL=""
    XUI_USER=""
    XUI_PASS=""
  fi

  # Limit User Online
  read -rp "Limit User Online (Default: 2000): " LIMIT
  LIMIT=${LIMIT:-2000}

  # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Public IP
  PUB_IP=$(get_public_ip)
  echo -e "${CYAN}[INFO]${NC} ‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö Public IP: $PUB_IP"

  # ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Nginx Port
  while true; do
    read -rp "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å Nginx Port (default: 82): " NGX_PORT
    NGX_PORT=${NGX_PORT:-82}
    if ! [[ "$NGX_PORT" =~ ^[0-9]+$ ]]; then
      echo -e "${RED}[ERROR]${NC} ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô."
      continue
    fi
    if (( NGX_PORT < 1 || NGX_PORT > 65535 )); then
      echo -e "${RED}[ERROR]${NC} Port must be 1-65535"
      continue
    fi
    if ss -tulnp | grep -w "$NGX_PORT" >/dev/null 2>&1; then
      echo -e "${YELLOW}[WARN]${NC} Port $NGX_PORT ‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡∏π‡πà, ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏≠‡∏£‡πå‡∏ï‡∏≠‡∏∑‡πà‡∏ô."
      continue
    fi
    break
  done

  echo -e "${GREEN}[OK]${NC} Nginx ‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡∏û‡∏≠‡∏£‡πå‡∏ï: $NGX_PORT"

  NIC=$(get_nic)
  [[ -z "$NIC" ]] && NIC=$(ip -o -4 addr show up scope global | awk '{print $2}' | head -n1)
  [[ -z "$NIC" ]] && NIC="eth0"

  # ======================= ‡∏™‡∏£‡πâ‡∏≤‡∏á config =======================
  cat >"$CONF_FILE" <<EOF
VERSION="${VERSION}"
WWW_DIR="$WWW_DIR"
LIMIT=${LIMIT}
DEBUG_LOG="$DEBUG_LOG"

PANEL_URL="$PANEL_URL"
XUI_USER="$XUI_USER"
XUI_PASS="$XUI_PASS"

NET_IFACE="$NIC"

# --- AGN-UDP (Hysteria) ---
AGN_PRESENT=$AGN_PRESENT
AGN_PORT="$AGN_PORT"
EOF
  chmod 600 "$CONF_FILE"

  # ======================= ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå =======================
  download_or_die "$SRC_ONLINE" "$SCRIPT_ONLINE"
  download_or_die "$SRC_VNSTAT" "$SCRIPT_VNSTAT"
  download_or_die "$SRC_V2RAY"  "$SCRIPT_V2RAY"
  download_or_die "$SRC_SYSINFO" "$SCRIPT_SYSINFO"
  chmod +x "$SCRIPT_ONLINE" "$SCRIPT_VNSTAT" "$SCRIPT_V2RAY" "$SCRIPT_SYSINFO"

  mkdir -p "$WWW_DIR"
  download_or_die "$SRC_INDEX" "$WWW_DIR/index.html"
  chmod 644 "$WWW_DIR/index.html"

  # include sites-enabled ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ
  NGX_CONF="/etc/nginx/nginx.conf"
  if ! grep -q "include /etc/nginx/sites-enabled/\*;" "$NGX_CONF"; then
    sed -i '/http {/a \    include /etc/nginx/sites-enabled/*;' "$NGX_CONF"
  fi

  # ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô site + reload nginx
  write_nginx "$NGX_PORT"
  systemctl enable --now nginx >/dev/null 2>&1 || true
  nginx -t && systemctl reload nginx
}
# =======================
# Part 2/4 ‡∏à‡∏ö‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
# =======================
# =====================================================
# Part 3/4 ‚Äî systemd Services + showon command + JSON
# =====================================================

# ----------------------------
# ‡∏™‡∏£‡πâ‡∏≤‡∏á systemd service ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏∏‡∏Å‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå
# ----------------------------

# Online Check (‡∏ó‡∏∏‡∏Å 5 ‡∏ß‡∏¥)
cat >"$SERVICE_ONLINE" <<'EOF'
[Unit]
Description=ShowOn Online Users JSON Generator
After=network-online.target
Wants=network-online.target

[Service]
Type=simple
ExecStart=/bin/bash -c 'while true; do /usr/local/bin/online-check.sh; sleep 5; done'
Restart=always
RestartSec=2

[Install]
WantedBy=multi-user.target
EOF

# vnStat Traffic
cat >"$SERVICE_VNSTAT" <<'EOF'
[Unit]
Description=ShowOn vnStat + V2Ray Traffic JSON Generator
After=network-online.target
Wants=network-online.target

[Service]
Type=simple
ExecStart=/bin/bash -c 'while true; do /usr/local/bin/vnstat-traffic.sh; sleep 5; done'
Restart=always
RestartSec=2

[Install]
WantedBy=multi-user.target
EOF

# V2Ray Traffic
cat >"$SERVICE_V2RAY" <<'EOF'
[Unit]
Description=ShowOn V2Ray-Only Traffic JSON Generator
After=network-online.target
Wants=network-online.target

[Service]
Type=simple
ExecStart=/bin/bash -c 'while true; do /usr/local/bin/v2ray-traffic.sh; sleep 5; done'
Restart=always
RestartSec=2

[Install]
WantedBy=multi-user.target
EOF

# System Info
cat >"$SERVICE_SYSINFO" <<'EOF'
[Unit]
Description=ShowOn System Info JSON Generator
After=network-online.target
Wants=network-online.target

[Service]
Type=simple
ExecStart=/bin/bash -c 'while true; do /usr/local/bin/sysinfo.sh; sleep 5; done'
Restart=always
RestartSec=2

[Install]
WantedBy=multi-user.target
EOF

# ----------------------------
# ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô service ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
# ----------------------------
systemctl daemon-reload
systemctl enable --now online-check.service vnstat-traffic.service v2ray-traffic.service sysinfo.service

# ----------------------------
# ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á showon ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÄ‡∏°‡∏ô‡∏π
# ----------------------------
SHOWON_BIN="/usr/local/bin/showon"

cat >"$SHOWON_BIN" <<'EOF'
#!/bin/bash
# showon - Run ShowOn menu from GitHub
set -euo pipefail

INSTALL_URL="https://raw.githubusercontent.com/TspKchn/showon/main/Install"
TMP_FILE=$(mktemp /tmp/showon_install_XXXXXX)

# ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå Install
if command -v curl >/dev/null 2>&1; then
    curl -fsSL "$INSTALL_URL" -o "$TMP_FILE"
elif command -v wget >/dev/null 2>&1; then
    wget -qO "$TMP_FILE" "$INSTALL_URL"
else
    echo "Error: curl or wget required" >&2
    exit 1
fi

# ‡∏£‡∏±‡∏ô‡πÑ‡∏ü‡∏•‡πå Install ‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß
bash "$TMP_FILE"

# ‡∏•‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß
rm -f "$TMP_FILE"
EOF

chmod +x "$SHOWON_BIN"
echo "[INFO] showon command installed at $SHOWON_BIN"

# ----------------------------
# ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå JSON ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Online + Dropbear + OpenVPN + Xray/V2Ray
# ----------------------------
ONLINE_JSON="$WWW_DIR/online_app.json"
ONLINE_FILE="$WWW_DIR/online_app"

generate_online_json() {
  # ‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡πà‡∏≤ limit ‡πÅ‡∏•‡∏∞ NIC ‡∏à‡∏≤‡∏Å config
  if [[ -f "$CONF_FILE" ]]; then
    source "$CONF_FILE"
  fi

  # ================= Dropbear =================
  DB_ON=0
  if pgrep dropbear >/dev/null 2>&1; then
    DB_ON=$(expr $(ps aux | grep '[d]ropbear' | grep -v grep | wc -l) - 1)
    [[ "$DB_ON" -lt 0 ]] && DB_ON=0
  fi

  # ================= OpenVPN =================
  OPENVPN_ON=0
  if [[ -f /etc/openvpn/server.conf ]]; then
    OPENVPN_ON=$(grep -c "client" /etc/openvpn/log/* 2>/dev/null || true)
  fi

  # ================= Xray/V2Ray =================
  V2RAY_ON=0
  if pgrep xray >/dev/null 2>&1 || pgrep v2ray >/dev/null 2>&1; then
    V2RAY_ON=$(expr $(ps aux | grep '[x]ray\|[v]2ray' | wc -l) - 1)
    [[ "$V2RAY_ON" -lt 0 ]] && V2RAY_ON=0
  fi

  # ================= JSON =================
  cat >"$ONLINE_JSON" <<EOF
{
  "dropbear_online": $DB_ON,
  "openvpn_online": $OPENVPN_ON,
  "v2ray_online": $V2RAY_ON,
  "limit": ${LIMIT:-2000},
  "timestamp": $(date +%s)
}
EOF

  # ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå online_app (‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•)
  cp "$ONLINE_JSON" "$ONLINE_FILE"
  chmod 644 "$ONLINE_JSON" "$ONLINE_FILE"
}

# ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å generate ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà run service
generate_online_json
# =====================================================
# Part 4/4 ‚Äî ‡πÄ‡∏°‡∏ô‡∏π, Uninstall, Update, Swap, Debug
# =====================================================

# =====================================================
# ‡∏ñ‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á
# =====================================================
uninstall_script() {
  echo -e "${CYAN}[INFO]${NC} Uninstalling ShowOn Script (Full Clean)..."

  # ‡∏´‡∏¢‡∏∏‡∏î‡πÅ‡∏•‡∏∞‡∏õ‡∏¥‡∏î service ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
  systemctl stop online-check.service vnstat-traffic.service v2ray-traffic.service sysinfo.service 2>/dev/null || true
  systemctl disable online-check.service vnstat-traffic.service v2ray-traffic.service sysinfo.service 2>/dev/null || true

  # ‡∏•‡∏ö service file
  rm -f "$SERVICE_ONLINE" "$SERVICE_VNSTAT" "$SERVICE_V2RAY" "$SERVICE_SYSINFO"
  systemctl daemon-reload

  # ‡∏•‡∏ö script ‡πÅ‡∏•‡∏∞ config
  rm -f "$SCRIPT_ONLINE" "$SCRIPT_VNSTAT" "$SCRIPT_V2RAY" "$SCRIPT_SYSINFO"
  rm -f "$CONF_FILE" "$DEBUG_LOG"

  # ‡∏•‡∏ö nginx site
  rm -f "$SITE_AV" "$SITE_EN"
  if systemctl is-active --quiet nginx; then
    systemctl reload nginx 2>/dev/null || true
  fi

  # ‡∏•‡∏ö command showon
  rm -f "$SHOWON_BIN"

  # ‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏≤‡∏Å‡∏ñ‡∏≠‡∏ô nginx ‡∏≠‡∏≠‡∏Å‡∏î‡πâ‡∏ß‡∏¢
  apt purge -y nginx >/dev/null 2>&1 || true
  apt autoremove -y >/dev/null 2>&1 || true

  # ‡∏•‡∏ö conntrack ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
  apt purge -y conntrack >/dev/null 2>&1 || true

  # ‡∏•‡∏ö‡∏Ñ‡πà‡∏≤ timeout ‡∏Ç‡∏≠‡∏á conntrack UDP ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å /etc/sysctl.conf
  sed -i '/^net\.netfilter\.nf_conntrack_udp_timeout=/d' /etc/sysctl.conf
  sed -i '/^net\.netfilter\.nf_conntrack_udp_timeout_stream=/d' /etc/sysctl.conf
  sysctl -p >/dev/null 2>&1 || true

  echo -e "${GREEN}[SUCCESS]${NC} Uninstalled completely."
}

# =====================================================
# ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Script
# =====================================================
update_script() {
  echo -e "${CYAN}[INFO]${NC} Updating all ShowOn components..."
  rotate_log

  download_or_die "$SRC_ONLINE?$(date +%s)" "$SCRIPT_ONLINE"
  download_or_die "$SRC_VNSTAT?$(date +%s)" "$SCRIPT_VNSTAT"
  download_or_die "$SRC_V2RAY?$(date +%s)" "$SCRIPT_V2RAY"
  download_or_die "$SRC_SYSINFO?$(date +%s)" "$SCRIPT_SYSINFO"
  chmod +x "$SCRIPT_ONLINE" "$SCRIPT_VNSTAT" "$SCRIPT_V2RAY" "$SCRIPT_SYSINFO"

  download_or_die "$SRC_INDEX?$(date +%s)" "$WWW_DIR/index.html"
  chmod 644 "$WWW_DIR/index.html"

  local TMP_SCRIPT="/tmp/Install.$$"
  if curl -fsSL "$REPO_RAW/Install?$(date +%s)" -o "$TMP_SCRIPT"; then
    mv "$TMP_SCRIPT" /root/Install
    chmod +x /root/Install
    echo -e "${GREEN}[OK]${NC} Updated Install script."
  else
    echo -e "${RED}[ERROR]${NC} Failed to update Install script."
  fi

  systemctl daemon-reload
  systemctl restart online-check vnstat-traffic v2ray-traffic sysinfo 2>/dev/null || true
  echo -e "${GREEN}[OK]${NC} Update completed."
}

# =====================================================
# Debug Log / Change Limit
# =====================================================
check_debug() {
  rotate_log
  if [[ -f "$DEBUG_LOG" ]]; then
    tail -n 100 "$DEBUG_LOG"
  else
    echo "No debug log yet."
  fi
  press
}

change_limit() {
  if [[ ! -f "$CONF_FILE" ]]; then
    echo -e "${RED}[ERROR]${NC} Config file not found!"
    press; return
  fi

  source "$CONF_FILE"
  echo -e "${CYAN}[INFO]${NC} Current Limit User Online: ${LIMIT:-2000}"
  read -rp "Enter new Limit User Online: " NEW_LIMIT
  if [[ -z "$NEW_LIMIT" ]]; then
    echo -e "${YELLOW}[WARN]${NC} ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ñ‡πà‡∏≤"
    press; return
  fi

  sed -i "s/^LIMIT=.*/LIMIT=${NEW_LIMIT}/" "$CONF_FILE"
  echo -e "${GREEN}[OK]${NC} ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô Limit User Online ‡πÄ‡∏õ‡πá‡∏ô ${NEW_LIMIT} ‡∏Ñ‡∏ô"
  press
}

# =====================================================
# Setup Swap
# =====================================================
setup_swap() {
  echo -e "${CYAN}[INFO]${NC} Auto Swap Wizard"

  local ram_kb=$(grep MemTotal /proc/meminfo | awk '{print $2}')
  local ram_mb=$(( ram_kb / 1024 ))
  local swap_mb

  if   (( ram_mb <= 512 )); then swap_mb=$(( ram_mb * 2 ))
  elif (( ram_mb <= 1024 )); then swap_mb=$(( ram_mb * 2 ))
  elif (( ram_mb <= 2048 )); then swap_mb=$(( ram_mb * 1 ))
  elif (( ram_mb <= 4096 )); then swap_mb=$(( ram_mb * 1 ))
  elif (( ram_mb <= 8192 )); then swap_mb=4096
  elif (( ram_mb <= 16384 )); then swap_mb=4096
  elif (( ram_mb <= 32768 )); then swap_mb=8192
  else swap_mb=8192
  fi

  if swapon --show | awk 'NR>1{print $1}' | grep -q .; then
    echo -e "${YELLOW}[WARN]${NC} ‡∏û‡∏ö Swap ‡πÄ‡∏î‡∏¥‡∏°"
    read -rp "‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡∏ö‡πÄ‡∏î‡∏¥‡∏°? (Y/n): " ans
    if [[ -z "$ans" || "$ans" =~ ^[Yy]$ ]]; then
      swapoff -a || true
      sed -i '/swapfile showon/d' /etc/fstab || true
    else
      echo -e "${GREEN}[OK]${NC} ‡∏Ç‡πâ‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á Swap ‡πÉ‡∏´‡∏°‡πà"
      press; return
    fi
  fi

  echo -e "${CYAN}[INFO]${NC} Creating swapfile ${swap_mb} MiB ..."
  fallocate -l "${swap_mb}M" /swapfile || dd if=/dev/zero of=/swapfile bs=1M count="${swap_mb}"
  chmod 600 /swapfile
  mkswap /swapfile >/dev/null
  swapon /swapfile

  if ! grep -q "swapfile showon" /etc/fstab; then
    echo "/swapfile none swap sw 0 0 # swapfile showon" >> /etc/fstab
  fi

  sysctl -w vm.swappiness=10 >/dev/null
  sysctl -w vm.vfs_cache_pressure=100 >/dev/null
  grep -q '^vm.swappiness' /etc/sysctl.conf || echo "vm.swappiness=10" >> /etc/sysctl.conf
  grep -q '^vm.vfs_cache_pressure' /etc/sysctl.conf || echo "vm.vfs_cache_pressure=100" >> /etc/sysctl.conf

  echo -e "${GREEN}[OK]${NC} Swap ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô:"
  free -h

  systemctl restart online-check.service vnstat-traffic.service v2ray-traffic.service sysinfo.service 2>/dev/null || true
  echo -e "${GREEN}[OK]${NC} Restarted ShowOn services."
  press
}

# =====================================================
# Main Menu
# =====================================================
show_menu() {
  clear
  print_status
  check_update
  echo "1) Install Script"
  echo "2) Uninstall Script"
  echo "3) Update Script"
  echo "4) Check Debug Log"
  echo "5) Change Limit User Online"
  echo "6) Setup Swap"
  echo "0) Exit"
  echo "==============================="
  read -rp "Choose an option [0-6]: " choice
  case "$choice" in
    1) install_script ;;
    2) uninstall_script ;;
    3) update_script ;;
    4) check_debug ;;
    5) change_limit ;;
    6) setup_swap ;;
    0) exit 0 ;;
    *) echo -e "${RED}[ERROR]${NC} Invalid choice"; sleep 1 ;;
  esac
  show_menu
}

# =====================================================
# Main
# =====================================================
require_root
show_menu
