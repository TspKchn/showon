#!/bin/bash
# ShowOn Script Manager V.1.0.5
# ตัวจัดการหลัก: เมนู Install / Uninstall / Update / Debug
# ------------------------------------------------------------

VERSION="V.1.0.5"
INSTALL_DIR="/usr/local/bin"
CONF_FILE="/etc/showon.conf"
WWW_DIR="/var/www/html/server"
DEBUG_LOG="/var/log/showon-debug.log"

show_menu() {
  clear
  echo "==============================="
  echo "   ShowOn Script Manager $VERSION"
  echo "==============================="
  echo "[OK] You are using the latest version."
  echo "1) Install Script"
  echo "2) Uninstall Script"
  echo "3) Update Script"
  echo "4) Check Debug Log"
  echo "0) Exit"
  echo "==============================="
  read -p "Choose an option [0,1,2,3,4]: " choice
  case $choice in
    1) install_script ;;
    2) uninstall_script ;;
    3) update_script ;;
    4) tail -n 50 "$DEBUG_LOG" ;;
    0) exit 0 ;;
    *) echo "Invalid choice"; sleep 2 ;;
  esac
  show_menu
}

install_script() {
  echo "[INFO] Installing ShowOn ($VERSION)..."
  apt update -y && apt upgrade -y
  apt install -y curl jq net-tools psmisc nginx iproute2 vnstat

  mkdir -p "$WWW_DIR"
  systemctl enable --now vnstat

  # ตั้งค่า 3x-ui
  echo "[INFO] ตั้งค่า 3x-ui (ถ้าไม่มีให้กด Enter ข้ามได้)"
  read -p "3X-UI URL (copy login link): " PANEL_BASE
  PANEL_BASE=${PANEL_BASE%/}
  read -p "3X-UI Username: " XUI_USER
  read -p "3X-UI Password: " XUI_PASS
  read -p "Limit User Online (Default: 2000): " LIMIT
  LIMIT=${LIMIT:-2000}

  cat > "$CONF_FILE" <<EOF
VERSION=$VERSION
WWW_DIR=$WWW_DIR
LIMIT=$LIMIT
DEBUG_LOG=$DEBUG_LOG
PANEL_BASE=$PANEL_BASE
XUI_USER=$XUI_USER
XUI_PASS=$XUI_PASS
EOF

  # Nginx site
  cat > /etc/nginx/sites-available/showon <<EOF
server {
    listen 82 default_server;
    root $WWW_DIR;
    index index.html;
    location / {
        autoindex on;
    }
}
EOF
  ln -sf /etc/nginx/sites-available/showon /etc/nginx/sites-enabled/showon
  nginx -t && systemctl restart nginx

  # Services
  systemctl daemon-reload
  systemctl enable --now online-check.service sysinfo.service vnstat-traffic.service v2ray-traffic.service

  echo "[OK] Installed ShowOn $VERSION"
  echo "[INFO] Open: http://$(hostname -I | awk '{print $1}'):82/server/"
}

uninstall_script() {
  echo "[INFO] Uninstalling ShowOn Script..."
  systemctl stop online-check.service sysinfo.service vnstat-traffic.service v2ray-traffic.service 2>/dev/null
  systemctl disable online-check.service sysinfo.service vnstat-traffic.service v2ray-traffic.service 2>/dev/null

  rm -f /usr/local/bin/online-check.sh
  rm -f /usr/local/bin/vnstat-traffic.sh
  rm -f /usr/local/bin/sysinfo.sh
  rm -f /etc/systemd/system/online-check.service
  rm -f /etc/systemd/system/vnstat-traffic.service
  rm -f /etc/systemd/system/sysinfo.service
  rm -f /etc/systemd/system/v2ray-traffic.service
  rm -f "$CONF_FILE"
  rm -rf "$WWW_DIR"

  systemctl daemon-reload
  systemctl restart nginx

  echo "[SUCCESS] Uninstalled completely."
}

update_script() {
  echo "[INFO] Checking for updates..."
  curl -s https://raw.githubusercontent.com/TspKchn/showon/refs/heads/main/Install -o /tmp/Install.new
  if ! cmp -s /tmp/Install.new "$0"; then
    cp /tmp/Install.new "$0"
    chmod +x "$0"
    echo "[OK] Updated! Run ./Install again."
    exit 0
  else
    echo "[OK] Already latest version."
  fi
}

show_menu
