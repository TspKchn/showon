<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>ShowOn Dashboard V.1.0.5</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    *{box-sizing:border-box}
    body{background:#0f1115;color:#eaecef;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu;max-width:1000px;margin:0 auto;padding:24px}
    h1{margin:0 0 12px}
    .muted{color:#9aa4b2}
    .grid{display:grid;grid-template-columns:1fr;gap:16px}
    @media(min-width:800px){.grid{grid-template-columns:1fr 1fr}}
    .card{background:#151a21;border:1px solid #202735;border-radius:10px;padding:16px}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{border:1px solid #2a3040;padding:10px;text-align:center}
    th{background:#1b2230}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,"Roboto Mono",monospace}
    .ok{color:#19c37d}.warn{color:#ffb300}.err{color:#ff4d4f}
  </style>
</head>
<body>
  <h1>ShowOn Dashboard <span class="muted">V.1.0.5</span></h1>
  <div class="grid">
    <div class="card">
      <h2>Online Summary</h2>
      <table>
        <thead>
          <tr>
            <th>Onlines</th><th>Limit</th><th>SSH</th><th>OpenVPN</th><th>Dropbear</th><th>V2Ray</th>
          </tr>
        </thead>
        <tbody><tr id="row-online"><td colspan="6">Loading...</td></tr></tbody>
      </table>
    </div>
    <div class="card">
      <h2>System</h2>
      <div class="mono" id="sys">Loading...</div>
    </div>
    <div class="card">
      <h2>Traffic</h2>
      <table>
        <thead id="traffic-head"></thead>
        <tbody><tr id="row-net"><td>Loading...</td></tr></tbody>
      </table>
      <div class="muted" style="margin-top:6px">* vnstat จะโชว์เสมอ, ส่วน V2Ray จะแสดงเฉพาะเมื่อมีข้อมูล</div>
    </div>
  </div>

  <script>
    let lastSys = null; // เก็บค่าล่าสุดของ System

    async function j(url){
      const r = await fetch(url+"?_="+Date.now(),{cache:"no-store"});
      if(!r.ok) throw new Error(r.status);
      return r.json();
    }
    function fmtBytes(n){
      if(!n || isNaN(n)) return "0 B";
      if(n<1024) return n+" B";
      const u=["KB","MB","GB","TB","PB"];
      let i=-1;
      do{n/=1024; i++}while(n>=1024&&i<u.length-1);
      return n.toFixed(2)+" "+u[i];
    }

    async function loadAll(){
      // --- Online Summary ---
      try{
        const a = await j('./online_app.json');
        const d = Array.isArray(a) ? a[0] : a;
        document.getElementById('row-online').innerHTML =
          `<td>${d.onlines}</td><td>${d.limite}</td><td>${d.ssh}</td><td>${d.openvpn}</td><td>${d.dropbear}</td><td>${d.v2ray}</td>`;
      }catch(e){
        // ค้างค่าเดิมไว้
      }

      // --- System Info ---
      try{
        const s = await j('./sysinfo.json');
        lastSys = s; // อัปเดตค่าใหม่
      }catch(e){
        // ใช้ค่าเก่าแทน
      }
      if(lastSys){
        document.getElementById('sys').innerText =
          `Uptime: ${lastSys.uptime}\nCPU: ${lastSys.cpu_usage}\nRAM: ${lastSys.ram_usage}\nDisk: ${lastSys.disk_usage}`;
      }

      // --- Traffic Info ---
      try{
        const n = await j('./netinfo.json');
        const d = Array.isArray(n) ? n[0] : n;

        if(d.v2ray && (d.v2ray.up > 0 || d.v2ray.down > 0)){
          document.getElementById('traffic-head').innerHTML =
            `<tr><th>vnStat RX</th><th>vnStat TX</th><th>V2Ray Up</th><th>V2Ray Down</th></tr>`;
          document.getElementById('row-net').innerHTML =
            `<td>${fmtBytes(d.vnstat.rx)}</td><td>${fmtBytes(d.vnstat.tx)}</td><td>${fmtBytes(d.v2ray.up)}</td><td>${fmtBytes(d.v2ray.down)}</td>`;
        }else{
          document.getElementById('traffic-head').innerHTML =
            `<tr><th>vnStat RX</th><th>vnStat TX</th></tr>`;
          document.getElementById('row-net').innerHTML =
            `<td>${fmtBytes(d.vnstat.rx)}</td><td>${fmtBytes(d.vnstat.tx)}</td>`;
        }
      }catch(e){
        // ค้างค่าเก่าไว้
      }
    }

    loadAll();
    setInterval(loadAll, 5000);
  </script>
</body>
</html>
